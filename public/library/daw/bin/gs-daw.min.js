"use strict";function gsuiOscilloscope(e){this.canvas=e,this.ctx=e.getContext("2d"),this.maxValue=0,this.setPinch(0),this.drawBegin(function(e,t,i,n){e.fillRect(0,0,i,n),e.lineWidth=2,e.strokeStyle="rgb(255,255,255)"}),this.drawEnd()}function gsuiPopup(e){this.elRoot=e,this.elWindow=e.querySelector(".gsuiPopup-window"),this.elHeader=e.querySelector(".gsuiPopup-window header"),this.elMsg=e.querySelector(".gsui-msg"),this.elText=e.querySelector(".gsui-text"),this.elCancel=e.querySelector(".gsui-cancel"),this.elOk=e.querySelector(".gsui-ok"),this.elForm=e.querySelector("form");var t=this;e.onclick=this.elCancel.onclick=function(){t.resolve("confirm"!==t.type&&("prompt"===t.type?null:void 0))},this.elWindow.onclick=function(e){e.stopPropagation()},this.elForm.onsubmit=function(){return t.resolve("confirm"===t.type||("prompt"===t.type?t.elText.value:void 0)),!1},this.elText.onkeypress=this.elText.onkeydown=this.elText.onkeyup=function(e){e.stopPropagation()}}function gsuiSpanEditable(e,t){this.element=e,this.data=t,this.placeholder="",this.span=e.querySelector("span"),this.input=e.querySelector("input"),e.ondblclick=this.__elementDblclick.bind(this),this.input.onblur=this.__inputBlur.bind(this),this.input.onkeydown=this.__inputKeydown.bind(this)}function gsuiToggle(e,t){this.element=e,this.data=t,this.isOn=!1,this._circleClass=e.querySelector(".gsui-circle").classList,e.oncontextmenu=function(){return!1},e.onmousedown=this.__elementMousedown.bind(this)}function gsuiWaveform(e){this.svg=e,this.polygon=e.querySelector("polygon")}function gswaContext(){this.ctx=new window.AudioContext,this.destination=this.ctx.destination,this.filters=this.createFilters(),this.nbPlaying=0,this.filters.connect(this.destination),this.nodeIn=this.filters.nodeIn,delete this.filters.connect}function gswaSample(e,t){this.wCtx=e,this.wBuffer=t,this.connectedTo=e.nodeIn,this.started=0,this.bufferSources=[],this.onended(function(){}),this.edit(0,0,t.duration),this.bufferDuration=t.duration}function gswaSampleGroup(){this.samples=[],this.samplesRev=[],this.updateDuration()}function gswaBuffer(e){this.wCtx=e,this.samples=[],this.sample=new gswaSample(e,this)}function gswaFilters(e){this.wCtx=e,this.nodes=[],this.nodeIn=e.ctx.createGain(),this.nodeOut=e.ctx.createGain(),this.nodeIn.connect(this.nodeOut),this.connect(e)}function gswaComposition(e){this.wCtx=e,this.samples=[],this.isPlaying=this.isPaused=!1,this.oldDuration=this.duration=this._startedTime=this._currentTime=0,this._bpm=60,this.fnOnended=this.fnOnpaused=function(){},this.onended=this.onended.bind(this),this._add=this._add.bind(this),this._remove=this._remove.bind(this)}function gswaFramework(){this.audioContext=new AudioContext,this.sampleGroup=new gswaSampleGroup,this.compositions=[],this.sources=[],this.tracks=[],this.on={},this.do={},this.currentComposition=null,this.bpm=60;for(var e in gswaFramework.do)this.do[e]=gswaFramework.do[e].bind(this),this.on[e]=function(){}}function checkLogin(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){ui.dom.accountSection;if(this.responseText){var t=JSON.parse(this.responseText);ui.dom.accountArea_SignedOut.remove(),ui.dom.loggedInUsername.textContent=t.username+" "}else ui.dom.accountArea_SignedIn.remove()}},e.open("GET","/api/user",!0),e.send()}window.AudioContext||(document.body.innerHTML="<div id='nowebaudio'>Sorry, <i><b>GridSound</b></i> is not compatible with this browser ¯\\_(ツ)_/¯<br/>Maybe you should use&nbsp;: <i class='icon chrome'></i> <i>Chrome</i> or <i class='icon firefox'></i> <i>Firefox</i> or <i class='icon safari'></i> <i>Safari</i>.</div>"),function(){function e(e){var t=keyboardRouter.defaultOptions,i=e.fn||t.fn,n={name:e.name,when:(e.when||t.when).toUpperCase(),preventDefault:void 0!==e.preventDefault?e.preventDefault:t.preventDefault,alt:!1,ctrl:!1,shift:!1,keys:[]};return n.fn=i.bind(e.thisArg||t.thisArg,e),e.keys.forEach(function(e){"ALT"===(e=e.toUpperCase())?n.alt=!0:"CTRL"===e?n.ctrl=!0:"SHIFT"===e?n.shift=!0:n.keys.push(1===e.length?e.charCodeAt(0):keyboardRouter.keys[e])}),n}function t(){for(;a.length;){var e=a.pop();e.active&&(delete e.active,e.fn({type:"keyup"}))}}function i(e){var t=e.keyCode;s[t]||(s[t]=!0,o.some(function(i){if(!(i.active||e.altKey!==i.alt||e.ctrlKey!==i.ctrl||e.shiftKey!==i.shift||i.keys.length&&t!==i.keys[0])&&(i.fn(e),i.when.indexOf("UP")>-1&&(i.active=!0,a.push(i)),!1!==i.preventDefault))return e.preventDefault(),!0}))}function n(e){var t,i,n,o=e.keyCode,r=a.length;if(s[o]=!1,r){for(n=[],t=r-1;t>=0;--t)(i=a[t]).active&&(i.alt&&!e.altKey||i.ctrl&&!e.ctrlKey||i.shift&&!e.shiftKey||i.keys.length||o===i.keys[0])&&n.push(t);n.forEach(function(t){delete(i=a[t]).active,i.fn(e),a.splice(t,1)})}}var s=[],o=[],a=[];window.keyboardRouter=function(){for(var s=0,a=arguments.length;s<a;)o.push(e(arguments[s++]));document.body.addEventListener("keydown",i),document.body.addEventListener("keyup",n),window.addEventListener("blur",t)},keyboardRouter.defaultOptions={when:"down",fn:function(){},preventDefault:!0},keyboardRouter.keys={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPSLOCK:20,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,OS:91,CONTEXTMENU:93,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUMLOCK:144,SCROLLLOCK:145}}(),function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Handlebars=t():e.Handlebars=t()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var s=i[n]={exports:{},id:n,loaded:!1};return e[n].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){function n(){var e=new a.HandlebarsEnvironment;return u.extend(e,a),e.SafeString=r.default,e.Exception=l.default,e.Utils=u,e.escapeExpression=u.escapeExpression,e.VM=c,e.template=function(t){return c.template(t,e)},e}var s=i(1).default,o=i(2).default;t.__esModule=!0;var a=s(i(3)),r=o(i(17)),l=o(i(5)),u=s(i(4)),c=s(i(18)),d=o(i(19)),p=n();p.create=n,d.default(p),p.default=p,t.default=p,e.exports=t.default},function(e,t){t.default=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t},t.__esModule=!0},function(e,t){t.default=function(e){return e&&e.__esModule?e:{default:e}},t.__esModule=!0},function(e,t,i){function n(e,t,i){this.helpers=e||{},this.partials=t||{},this.decorators=i||{},r.registerDefaultHelpers(this),l.registerDefaultDecorators(this)}var s=i(2).default;t.__esModule=!0,t.HandlebarsEnvironment=n;var o=i(4),a=s(i(5)),r=i(6),l=i(14),u=s(i(16));t.VERSION="4.0.5";t.COMPILER_REVISION=7;var c={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0"};t.REVISION_CHANGES=c;var d="[object Object]";n.prototype={constructor:n,logger:u.default,log:u.default.log,registerHelper:function(e,t){if(o.toString.call(e)===d){if(t)throw new a.default("Arg not supported with multiple helpers");o.extend(this.helpers,e)}else this.helpers[e]=t},unregisterHelper:function(e){delete this.helpers[e]},registerPartial:function(e,t){if(o.toString.call(e)===d)o.extend(this.partials,e);else{if(void 0===t)throw new a.default('Attempting to register a partial called "'+e+'" as undefined');this.partials[e]=t}},unregisterPartial:function(e){delete this.partials[e]},registerDecorator:function(e,t){if(o.toString.call(e)===d){if(t)throw new a.default("Arg not supported with multiple decorators");o.extend(this.decorators,e)}else this.decorators[e]=t},unregisterDecorator:function(e){delete this.decorators[e]}};var p=u.default.log;t.log=p,t.createFrame=o.createFrame,t.logger=u.default},function(e,t){function i(e){return c[e]}function n(e){for(var t=1;t<arguments.length;t++)for(var i in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],i)&&(e[i]=arguments[t][i]);return e}function s(e,t){for(var i=0,n=e.length;n>i;i++)if(e[i]===t)return i;return-1}function o(e){if("string"!=typeof e){if(e&&e.toHTML)return e.toHTML();if(null==e)return"";if(!e)return e+"";e=""+e}return p.test(e)?e.replace(d,i):e}function a(e){return!e&&0!==e||!(!h(e)||0!==e.length)}function r(e){var t=n({},e);return t._parent=e,t}function l(e,t){return e.path=t,e}function u(e,t){return(e?e+".":"")+t}t.__esModule=!0,t.extend=n,t.indexOf=s,t.escapeExpression=o,t.isEmpty=a,t.createFrame=r,t.blockParams=l,t.appendContextPath=u;var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},d=/[&<>"'`=]/g,p=/[&<>"'`=]/,m=Object.prototype.toString;t.toString=m;var f=function(e){return"function"==typeof e};f(/x/)&&(t.isFunction=f=function(e){return"function"==typeof e&&"[object Function]"===m.call(e)}),t.isFunction=f;var h=Array.isArray||function(e){return!(!e||"object"!=typeof e)&&"[object Array]"===m.call(e)};t.isArray=h},function(e,t){function i(e,t){var s=t&&t.loc,o=void 0,a=void 0;s&&(o=s.start.line,a=s.start.column,e+=" - "+o+":"+a);for(var r=Error.prototype.constructor.call(this,e),l=0;l<n.length;l++)this[n[l]]=r[n[l]];Error.captureStackTrace&&Error.captureStackTrace(this,i),s&&(this.lineNumber=o,this.column=a)}t.__esModule=!0;var n=["description","fileName","lineNumber","message","name","number","stack"];i.prototype=new Error,t.default=i,e.exports=t.default},function(e,t,i){function n(e){o.default(e),a.default(e),r.default(e),l.default(e),u.default(e),c.default(e),d.default(e)}var s=i(2).default;t.__esModule=!0,t.registerDefaultHelpers=n;var o=s(i(7)),a=s(i(8)),r=s(i(9)),l=s(i(10)),u=s(i(11)),c=s(i(12)),d=s(i(13))},function(e,t,i){t.__esModule=!0;var n=i(4);t.default=function(e){e.registerHelper("blockHelperMissing",function(t,i){var s=i.inverse,o=i.fn;if(!0===t)return o(this);if(!1===t||null==t)return s(this);if(n.isArray(t))return t.length>0?(i.ids&&(i.ids=[i.name]),e.helpers.each(t,i)):s(this);if(i.data&&i.ids){var a=n.createFrame(i.data);a.contextPath=n.appendContextPath(i.data.contextPath,i.name),i={data:a}}return o(t,i)})},e.exports=t.default},function(e,t,i){var n=i(2).default;t.__esModule=!0;var s=i(4),o=n(i(5));t.default=function(e){e.registerHelper("each",function(e,t){function i(t,i,o){u&&(u.key=t,u.index=i,u.first=0===i,u.last=!!o,c&&(u.contextPath=c+t)),l+=n(e[t],{data:u,blockParams:s.blockParams([e[t],t],[c+t,null])})}if(!t)throw new o.default("Must pass iterator to #each");var n=t.fn,a=t.inverse,r=0,l="",u=void 0,c=void 0;if(t.data&&t.ids&&(c=s.appendContextPath(t.data.contextPath,t.ids[0])+"."),s.isFunction(e)&&(e=e.call(this)),t.data&&(u=s.createFrame(t.data)),e&&"object"==typeof e)if(s.isArray(e))for(var d=e.length;d>r;r++)r in e&&i(r,r,r===e.length-1);else{var p=void 0;for(var m in e)e.hasOwnProperty(m)&&(void 0!==p&&i(p,r-1),p=m,r++);void 0!==p&&i(p,r-1,!0)}return 0===r&&(l=a(this)),l})},e.exports=t.default},function(e,t,i){var n=i(2).default;t.__esModule=!0;var s=n(i(5));t.default=function(e){e.registerHelper("helperMissing",function(){if(1!==arguments.length)throw new s.default('Missing helper: "'+arguments[arguments.length-1].name+'"')})},e.exports=t.default},function(e,t,i){t.__esModule=!0;var n=i(4);t.default=function(e){e.registerHelper("if",function(e,t){return n.isFunction(e)&&(e=e.call(this)),!t.hash.includeZero&&!e||n.isEmpty(e)?t.inverse(this):t.fn(this)}),e.registerHelper("unless",function(t,i){return e.helpers.if.call(this,t,{fn:i.inverse,inverse:i.fn,hash:i.hash})})},e.exports=t.default},function(e,t){t.__esModule=!0,t.default=function(e){e.registerHelper("log",function(){for(var t=[void 0],i=arguments[arguments.length-1],n=0;n<arguments.length-1;n++)t.push(arguments[n]);var s=1;null!=i.hash.level?s=i.hash.level:i.data&&null!=i.data.level&&(s=i.data.level),t[0]=s,e.log.apply(e,t)})},e.exports=t.default},function(e,t){t.__esModule=!0,t.default=function(e){e.registerHelper("lookup",function(e,t){return e&&e[t]})},e.exports=t.default},function(e,t,i){t.__esModule=!0;var n=i(4);t.default=function(e){e.registerHelper("with",function(e,t){n.isFunction(e)&&(e=e.call(this));var i=t.fn;if(n.isEmpty(e))return t.inverse(this);var s=t.data;return t.data&&t.ids&&(s=n.createFrame(t.data),s.contextPath=n.appendContextPath(t.data.contextPath,t.ids[0])),i(e,{data:s,blockParams:n.blockParams([e],[s&&s.contextPath])})})},e.exports=t.default},function(e,t,i){function n(e){o.default(e)}var s=i(2).default;t.__esModule=!0,t.registerDefaultDecorators=n;var o=s(i(15))},function(e,t,i){t.__esModule=!0;var n=i(4);t.default=function(e){e.registerDecorator("inline",function(e,t,i,s){var o=e;return t.partials||(t.partials={},o=function(s,o){var a=i.partials;i.partials=n.extend({},a,t.partials);var r=e(s,o);return i.partials=a,r}),t.partials[s.args[0]]=s.fn,o})},e.exports=t.default},function(e,t,i){t.__esModule=!0;var n=i(4),s={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(e){if("string"==typeof e){var t=n.indexOf(s.methodMap,e.toLowerCase());e=t>=0?t:parseInt(e,10)}return e},log:function(e){if(e=s.lookupLevel(e),"undefined"!=typeof console&&s.lookupLevel(s.level)<=e){var t=s.methodMap[e];console[t]||(t="log");for(var i=arguments.length,n=Array(i>1?i-1:0),o=1;i>o;o++)n[o-1]=arguments[o];console[t].apply(console,n)}}};t.default=s,e.exports=t.default},function(e,t){function i(e){this.string=e}t.__esModule=!0,i.prototype.toString=i.prototype.toHTML=function(){return""+this.string},t.default=i,e.exports=t.default},function(e,t,i){function n(e){var t=e&&e[0]||1,i=h.COMPILER_REVISION;if(t!==i){if(i>t){var n=h.REVISION_CHANGES[i],s=h.REVISION_CHANGES[t];throw new f.default("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+n+") or downgrade your runtime to an older version ("+s+").")}throw new f.default("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+e[1]+").")}}function s(e,t){function i(i,n,s){s.hash&&(n=m.extend({},n,s.hash),s.ids&&(s.ids[0]=!0)),i=t.VM.resolvePartial.call(this,i,n,s);var o=t.VM.invokePartial.call(this,i,n,s);if(null==o&&t.compile&&(s.partials[s.name]=t.compile(i,e.compilerOptions,t),o=s.partials[s.name](n,s)),null!=o){if(s.indent){for(var a=o.split("\n"),r=0,l=a.length;l>r&&(a[r]||r+1!==l);r++)a[r]=s.indent+a[r];o=a.join("\n")}return o}throw new f.default("The partial "+s.name+" could not be compiled when running in runtime-only mode")}function n(t){function i(t){return""+e.main(s,t,s.helpers,s.partials,a,l,r)}var o=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=o.data;n._setup(o),!o.partial&&e.useData&&(a=u(t,a));var r=void 0,l=e.useBlockParams?[]:void 0;return e.useDepths&&(r=o.depths?t!==o.depths[0]?[t].concat(o.depths):o.depths:[t]),(i=c(e.main,i,s,o.depths||[],a,l))(t,o)}if(!t)throw new f.default("No environment passed to template");if(!e||!e.main)throw new f.default("Unknown template object: "+typeof e);e.main.decorator=e.main_d,t.VM.checkRevision(e.compiler);var s={strict:function(e,t){if(!(t in e))throw new f.default('"'+t+'" not defined in '+e);return e[t]},lookup:function(e,t){for(var i=e.length,n=0;i>n;n++)if(e[n]&&null!=e[n][t])return e[n][t]},lambda:function(e,t){return"function"==typeof e?e.call(t):e},escapeExpression:m.escapeExpression,invokePartial:i,fn:function(t){var i=e[t];return i.decorator=e[t+"_d"],i},programs:[],program:function(e,t,i,n,s){var a=this.programs[e],r=this.fn(e);return t||s||n||i?a=o(this,e,r,t,i,n,s):a||(a=this.programs[e]=o(this,e,r)),a},data:function(e,t){for(;e&&t--;)e=e._parent;return e},merge:function(e,t){var i=e||t;return e&&t&&e!==t&&(i=m.extend({},t,e)),i},noop:t.VM.noop,compilerInfo:e.compiler};return n.isTop=!0,n._setup=function(i){i.partial?(s.helpers=i.helpers,s.partials=i.partials,s.decorators=i.decorators):(s.helpers=s.merge(i.helpers,t.helpers),e.usePartial&&(s.partials=s.merge(i.partials,t.partials)),(e.usePartial||e.useDecorators)&&(s.decorators=s.merge(i.decorators,t.decorators)))},n._child=function(t,i,n,a){if(e.useBlockParams&&!n)throw new f.default("must pass block params");if(e.useDepths&&!a)throw new f.default("must pass parent depths");return o(s,t,e[t],i,0,n,a)},n}function o(e,t,i,n,s,o,a){function r(t){var s=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=a;return a&&t!==a[0]&&(r=[t].concat(a)),i(e,t,e.helpers,e.partials,s.data||n,o&&[s.blockParams].concat(o),r)}return r=c(i,r,e,a,n,o),r.program=t,r.depth=a?a.length:0,r.blockParams=s||0,r}function a(e,t,i){return e?e.call||i.name||(i.name=e,e=i.partials[e]):e="@partial-block"===i.name?i.data["partial-block"]:i.partials[i.name],e}function r(e,t,i){i.partial=!0,i.ids&&(i.data.contextPath=i.ids[0]||i.data.contextPath);var n=void 0;if(i.fn&&i.fn!==l&&(i.data=h.createFrame(i.data),(n=i.data["partial-block"]=i.fn).partials&&(i.partials=m.extend({},i.partials,n.partials))),void 0===e&&n&&(e=n),void 0===e)throw new f.default("The partial "+i.name+" could not be found");return e instanceof Function?e(t,i):void 0}function l(){return""}function u(e,t){return t&&"root"in t||(t=t?h.createFrame(t):{},t.root=e),t}function c(e,t,i,n,s,o){if(e.decorator){var a={};t=e.decorator(t,a,i,n&&n[0],s,o,n),m.extend(t,a)}return t}var d=i(1).default,p=i(2).default;t.__esModule=!0,t.checkRevision=n,t.template=s,t.wrapProgram=o,t.resolvePartial=a,t.invokePartial=r,t.noop=l;var m=d(i(4)),f=p(i(5)),h=i(3)},function(e,t){(function(i){t.__esModule=!0,t.default=function(e){var t=void 0!==i?i:window,n=t.Handlebars;e.noConflict=function(){return t.Handlebars===e&&(t.Handlebars=n),e}},e.exports=t.default}).call(t,function(){return this}())}])}),function(){var e=Handlebars.template,t=Handlebars.templates=Handlebars.templates||{};t.gsuiOscilloscope=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<canvas class="gsuiOscilloscope"></canvas>\n'},useData:!0}),t.gsuiPopup=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<div class="gsuiPopup">\n\t<div class="gsuiPopup-window">\n\t\t<header></header>\n\t\t<div class="gsui-msg"></div>\n\t\t<form>\n\t\t\t<input type="text" class="gsui-text"\n\t\t\t/><input type="button" class="gsui-btn gsui-cancel" value="Cancel"\n\t\t\t/><input type="submit" class="gsui-btn gsui-ok" value="Ok"/>\n\t\t</form>\n\t</div>\n</div>\n'},useData:!0}),t.gsuiSpanEditable=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<div class="gsuiSpanEditable">\n\t<span class="gsui-textOverflow"></span>\n\t<input type="text"/>\n</div>\n'},useData:!0}),t.gsuiToggle=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<div class="gsuiToggle">\n\t<div class="gsui-circle"></div>\n</div>'},useData:!0}),t.gsuiWaveform=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<svg class="gsuiWaveform" preserveAspectRatio="none">\n\t<polygon/>\n</svg>\n'},useData:!0})}(),gsuiOscilloscope.prototype={setResolution:function(e,t){this.canvas.width=e,this.canvas.height=t},setPinch:function(e){this.pinch=Math.max(0,Math.min(e,1))},clear:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},startAnimation:function(){if(!this.frameId){var e=this;this.frameId=requestAnimationFrame(function t(){e.draw(e.fnData()),e.frameId=requestAnimationFrame(t)})}},stopAnimation:function(){cancelAnimationFrame(this.frameId),this.frameId=null},dataFunction:function(e){this.fnData=e},drawBegin:function(e){this.fnBegin=e||function(){}},drawEnd:function(e){this.fnEnd=e||function(){}},draw:function(e){var t,i,n=this.maxValue,s=this.canvas,o=this.ctx,a=s.width,r=s.height,l=r/2,u=e.length,c=Math.ceil(this.pinch/2*u),d=a/(u-1);if(!1!==this.fnBegin(o,n,a,r)){for(o.beginPath(),n=0,t=0;t<u;++t)i=e[t]/128-1,n=Math.max(n,Math.abs(i)),(t<c||u-c<=t)&&(i*=.5-Math.cos(Math.PI*(t<c?t:u-1-t)/c)/2),0===t?o.moveTo(0,l+i*l):o.lineTo(t*d,l+i*l);this.fnEnd(o,n,a,r),o.stroke(),this.maxValue=n}}},gsuiPopup.prototype={close:function(){this.isOpen&&this.elCancel.click()},open:function(e,t,i,n){this.isOpen=!0,this.elHeader.textContent=t,this.elMsg.innerHTML=i,this.elText.value=arguments.length>3?n:"",this.elWindow.dataset.gsuiType=this.type=e,this.elWindow.classList.toggle("gsui-nocancel","prompt"!==e&&"confirm"!==e),this.elWindow.classList.toggle("gsui-notext","prompt"!==e),this.elRoot.classList.add("gsui-show");var s=this;return setTimeout(function(){"prompt"===e?s.elText.select():s.elOk.focus()},250),new Promise(function(e){s.resolve=e}).then(function(e){return s.isOpen=!1,s.elRoot.classList.remove("gsui-show"),e})}},gsuiSpanEditable.prototype={getValue:function(){return this.value},setValue:function(e){(e=e.trim())===this.placeholder&&(e=""),this.element.classList.toggle("gsui-empty",!e),this.span.textContent=e||this.placeholder,e!==this.value&&(this.value=e,this.data.onchange&&this.data.onchange(this.value))},setPlaceholder:function(e){this.placeholder=e.trim(),this.value||this.setValue(e)},__elementDblclick:function(e){this.input.value=this.value,this.element.classList.add("gsui-editing"),this.input.focus(),this.input.select()},__inputBlur:function(e){this.__esc||(this.setValue(e.target.value),this.element.classList.remove("gsui-editing")),this.__esc=!1},__inputKeydown:function(e){e.stopPropagation(),13!==e.keyCode&&27!==e.keyCode||(this.__esc=27===e.keyCode,this.__esc||this.setValue(e.target.value),this.element.classList.remove("gsui-editing"))}},gsuiToggle.prototype={toggle:function(e){e!==this.isOn&&(this.isOn=e,this._circleClass.toggle("gsui-on",e),this.data.onchange&&this.data.onchange(e))},groupWith:function(e){var t=this.group;e.group=e.group||[e],e!==this&&t!==e.group&&(t&&t.splice(t.indexOf(this),1),this.group=e.group,e.group.push(this))},__elementMousedown:function(e){if(0===e.button)this.toggle(!this.isOn);else if(2===e.button){if(this.group){var t=this.group.every(function(e){return e===this||!e.isOn},this);this.group.forEach(function(e){e!==this&&e.toggle(t)},this)}this.toggle(!0)}}},gsuiWaveform.prototype={setResolution:function(e,t){this.width=e,this.height=t,this.svg.setAttribute("viewBox","0 0 "+e+" "+t)},draw:function(e,t,i,n,s){var o,a=this.width,r=this.height,l=r/2,u=e.length,c=~~(n/i*u),d=s/i*u/a,p="0,"+(l+e[c]*l),m="0,"+(l+t[c]*l),f=~~Math.max(1,d/100);for(o=1;o<a;++o){for(var h=1/0,g=-1/0,v=~~(c+(o-1)*d),w=v+d;v<w;v+=f)h=Math.min(h,e[v],t[v]),g=Math.max(g,t[v],e[v]);Math.abs(g-h)*l<1&&(g+=1/r,h-=1/r),p+=" "+o+","+(l+h*l),m=o+","+(l+g*l)+" "+m}this.polygon.setAttribute("points",p+" "+m)}},gswaContext.prototype={gain:function(e){return arguments.length?(this.filter.gain(e),this):this.filter.gain()},createSample:function(e){var t=new gswaSample(this,e);return e.samples.push(t),t},createBuffer:function(){return new gswaBuffer(this)},createFilters:function(){return new gswaFilters(this)},createComposition:function(){return new gswaComposition(this)}},function(){function e(e,t){for(var i=0,n=0,s=e.length+t.length,o=new Float32Array(s);i<s;)o[i++]=e[n],o[i++]=t[n++];return o}function t(e,t,i){for(var n=0;n<i.length;++n)e.setUint8(t+n,i.charCodeAt(n))}function i(e,t,i){for(var n,s=0;s<i.length;++s,t+=2)n=Math.max(-1,Math.min(i[s],1)),e.setInt16(t,n<0?32768*n:32767*n,!0)}function n(e,t,i){for(var n=0;n<i.length;++n,t+=4)e.setFloat32(t,i[n],!0)}window.gswaEncodeWAV=function(s,o){var a=s.numberOfChannels,r=s.sampleRate,l=o&&o.float32?3:1,u=3===l?32:16,c=u/8,d=a*c,p=2===a?e(s.getChannelData(0),s.getChannelData(1)):s.getChannelData(0),m=new ArrayBuffer(44+p.length*c),f=new DataView(m);return t(f,0,"RIFF"),f.setUint32(4,36+p.length*c,!0),t(f,8,"WAVE"),t(f,12,"fmt "),f.setUint32(16,16,!0),f.setUint16(20,l,!0),f.setUint16(22,a,!0),f.setUint32(24,r,!0),f.setUint32(28,r*d,!0),f.setUint16(32,d,!0),f.setUint16(34,u,!0),t(f,36,"data"),f.setUint32(40,p.length*c,!0),(1===l?i:n)(f,44,p),m}}(),gswaSample.prototype={edit:function(e,t,i){return null!=e&&(this.when=e),null!=t&&(this.offset=t),null!=i&&(this.duration=i),this},connect:function(e){return(e=e.nodeIn||e)instanceof AudioNode&&(this.connectedTo=e,this.bufferSources.forEach(function(t){t.connect(e)})),this},disconnect:function(){return this.connectedTo=null,this.bufferSources.forEach(function(e){e.disconnect()}),this},start:function(e,t,i){if(this.wBuffer.buffer){var n=this.wCtx.ctx.createBufferSource();e=null!=e?e:this.when,t=null!=t?t:this.offset,i=null!=i?i:this.duration,n.buffer=this.wBuffer.buffer,n.onended=this._bsrcOnended.bind(this,n,!0),n.connect(this.connectedTo),this.bufferSources.push(n),n.start(this.wCtx.ctx.currentTime+e,t,i),++this.started,e>0?n.gs__onplayTimeoutId=setTimeout(this._bsrcOnplay.bind(this,n),1e3*e):this._bsrcOnplay(n)}return this},stop:function(){return this.started&&(this.bufferSources.forEach(function(e){e.onended=null,e.stop(0),this._bsrcOnended(e,!1)},this),this.bufferSources.length=0),this},onended:function(e){return this._userOnended=e,this},_bsrcOnplay:function(e){e.gs__isPlaying=!0,++this.wCtx.nbPlaying},_bsrcOnended:function(e,t){clearTimeout(e.gs__onplayTimeoutId),e.gs__isPlaying&&(e.gs__isPlaying=!1,--this.wCtx.nbPlaying),t&&this.bufferSources.splice(this.bufferSources.indexOf(e),1),--this.started,this._userOnended()}},gswaSampleGroup.prototype={stretch:function(e){this.samples.forEach(function(t){t.whenRel*=e}),this.updateDuration()},start:function(e,t,i){var n=this.samples[0];n&&(t=t||0,i=arguments.length>2?i:this.duration,e||(e=n.sample.ctx.currentTime),this.samples.forEach(function(n){var s=n.whenRel-t,o=n.duration,a=n.offset;s<0&&(a-=s,o+=s),o>0&&(o+=Math.min(i-s-o,0))>0&&n.sample.start(e+s,a,o)}))},stop:function(){this.samples.forEach(function(e){e.sample.stop()})},addSample:function(e){e.offset=e.offset||0,e.duration=e.duration||e.sample.duration,this.samples.push(e),this.samplesRev.push(e)},addSamples:function(e){e.forEach(this.addSample.bind(this))},removeSample:function(e){function t(t){t.splice(t.findIndex(function(t){return t===e}),1)}t(this.samples),t(this.samplesRev)},removeSamples:function(e){e.forEach(this.removeSample.bind(this))},updateDuration:function(){var e=this.samplesRev[0];this.duration=e?e.whenRel+e.duration:0},sortSamples:function(){function e(e,t){return e<t?-1:e>t?1:0}this.samples.sort(function(t,i){return e(t.whenRel,i.whenRel)}),this.samplesRev.sort(function(t,i){return e(i.whenRel+i.duration,t.whenRel+t.duration)})}},gswaBuffer.prototype={setFile:function(e){var t=this;return new Promise(function(i,n){function s(e){t.wCtx.ctx.decodeAudioData(e,function(e){t._setData(e),i(t)},n)}if(e.name){var o=new FileReader;o.addEventListener("loadend",function(){s(o.result)}),o.readAsArrayBuffer(e)}else s(e)})},_setData:function(e){this.buffer=e,this._setDuration(e.duration)},_setDuration:function(e){function t(t){t.bufferDuration=e,(null==t.duration||t.duration>e)&&(t.duration=e)}this.duration=e,this.samples.forEach(t),t(this.sample)},getPeaks:function(e,t,i,n){i=i||0,n=void 0===n?this.buffer.duration-i:Math.min(n,this.buffer.duration-i);for(var s,o,a,r=0,l=new Array(t),u=this.buffer.getChannelData(e),c=n*this.buffer.sampleRate,d=i*this.buffer.sampleRate,p=c/t,m=~~Math.max(1,p/10);r<t;++r){for(o=(s=d+r*p)+p,a=0;s<o;s+=m)a=Math.max(a,Math.abs(u[~~s]));l[r]=a}return l}},gswaFilters.prototype={connect:function(e){(e=e.nodeIn||e)instanceof AudioNode&&(this.connectedTo=e,this.nodeOut.connect(e))},disconnect:function(){this.nodeOut.disconnect(),this.connectedTo=null},empty:function(){this.nodes.length&&(this.nodes[this.nodes.length-1].disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut),this.nodes=[])},gain:function(e){return arguments.length?void(this.nodeOut.gain.value=e):this.nodeOut.gain.value},pushBack:function(e){if(this.nodes.length){var t=this.nodes[this.nodes.length-1];t.disconnect(),t.connect(e)}else this.nodeIn.disconnect(),this.nodeIn.connect(e);e.connect(this.nodeOut),this.nodes.push(e)},pushFront:function(e){this.nodes.length?(this.nodeIn.disconnect(),this.nodeIn.connect(e),e.connect(this.nodes[0]),this.nodes.unshift(e)):this.pushBack(e)},popBack:function(){var e=this.nodes.pop();if(e)if(e.disconnect(),this.nodes.length){var t=this.nodes[this.nodes.length-1];t.disconnect(),t.connect(this.nodeOut)}else this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut);return e},popFront:function(){var e=this.nodes.shift();return e&&(e.disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodes[0]||this.nodeOut)),e}},gswaComposition.prototype={bpm:function(e){if(!arguments.length)return this._bpm;if((e=Math.max(1,e))!==this._bpm){var t=this._bpm/60/(e/60),i=this.currentTime();this.samples.forEach(function(e){e.when*=t}),this.isLooping&&this.loop(this.loopWhen*t,this.loopDuration*t),this._bpm=e,this._updateDuration(),this.currentTime(i*t)}return this},add:function(e){return e.forEach?e.forEach(this._add):this._add(e),this},remove:function(e){return e.forEach?e.forEach(this._remove):this._remove(e),this},getSampleAt:function(e){return this.samples.findIndex(function(t){return t.when+t.duration>e})},update:function(e,t){return"rm"!==t&&this.samples.sort(function(e,t){return e.when<t.when?-1:e.when>t.when?1:0}),this._updateDuration(),this.oldDuration!==this.duration&&this._updateEndTimeout(),this.isPlaying&&(e.stop(),"rm"!==t&&(this.isLooping?this._loopUpdate(e):this._sampleStart(e,0,this.currentTime(),1/0))),this},currentTime:function(e){function t(e){return!i.isLooping||e<i.loopEnd?e:i.loopWhen+(e-i.loopWhen)%i.loopDuration}var i=this;return arguments.length?(this.isPlaying&&this._stop(),this._currentTime=t(Math.max(0,Math.min(e,this.duration))),this.isPlaying&&this._play(),this):this.isPlaying?t(this._currentTime+this.wCtx.ctx.currentTime-this._startedTime):this._currentTime},play:function(){return this.isPlaying||(this.isPlaying=!0,this.isPaused=!1,this._play()),this},stop:function(){return(this.isPlaying||this.isPaused)&&(this._stop(),this.onended()),this},pause:function(){return this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this._currentTime+=this.wCtx.ctx.currentTime-this._startedTime,this._startedTime=0,this._stop(),this.fnOnpaused()),this},onended:function(e){return"function"==typeof e?this.fnOnended=e:(this.isPlaying=this.isPaused=!1,this._startedTime=this._currentTime=0,this.fnOnended()),this},_add:function(e){this.samples.indexOf(e)<0&&(this.samples.push(e),e.composition=this,this.update(e,"ad"))},_remove:function(e){var t=this.samples.indexOf(e);t>-1&&(e.composition=null,this.samples.splice(t,1),this.update(e,"rm"))},_stop:function(){clearTimeout(this._endTimeout),clearTimeout(this._loopTimeout),this.samples.forEach(function(e){e.stop()})},_play:function(){this._startedTime=this.wCtx.ctx.currentTime,this.isLooping?this._loopPlay():this.samples.forEach(function(e){this._sampleStart(e,0,this.currentTime(),1/0)},this),this._updateEndTimeout()},_updateDuration:function(){var e=this.samples[this.samples.length-1];this.duration=e?e.when+e.duration:0},_updateEndTimeout:function(){if(clearTimeout(this._endTimeout),this.isPlaying&&!this.isLooping){var e=this.duration-this.currentTime();this.oldDuration=this.duration,e<=0?this.onended():this._endTimeout=setTimeout(this.onended,1e3*e)}},_sampleStart:function(e,t,i,n){var s=e.when,o=e.offset,a=e.duration,r=s-i;r>-a&&s<n&&(s+a>n&&(a-=s+a-n),r<0&&(o-=r,a+=r,r=0),e.start(r+t,o,a))}},Object.assign(gswaComposition.prototype,{loop:function(e,t){return this.isLooping=!1!==e,this.isLooping?(this.loopWhen=e,this.loopDuration=t,this.loopEnd=e+t):clearTimeout(this._loopTimeout),this.isPlaying&&this.currentTime(this.currentTime()),this},_loopPlay:function(){clearTimeout(this._loopTimeout),this.samples.some(function(e){return!(e.when<this.loopEnd)||void this._sampleStart(e,0,this.currentTime(),this.loopEnd)},this),this.currentTime()>=this.loopWhen?this._loopStart():this._loopTimeout=setTimeout(this._loopStart.bind(this),1e3*(this.loopWhen-this.currentTime()))},_loopStart:function(){this._loopN=Math.ceil(2/this.loopDuration),this._loopNbStarted=1,this._loopTimeout=setInterval(this._loopTimer.bind(this),1e3),this._loopTimer()},_loopRemain:function(){return this._loopNbStarted-(this.wCtx.ctx.currentTime-this._startedTime+this._currentTime-this.loopWhen)/this.loopDuration},_loopTimer:function(){if(this._loopRemain()<this._loopN){var e,t,i=0,n=this.getSampleAt(this.loopWhen);if(n>-1)for(;i++<this._loopN;){for(t=n;(e=this.samples[t])&&e.when<this.loopEnd;++t)this._sampleStart(e,this._loopRemain()*this.loopDuration,this.loopWhen,this.loopEnd);++this._loopNbStarted}}},_loopUpdate:function(e){if(this._sampleStart(e,0,this.currentTime(),this.loopEnd),e.when+e.duration>this.loopWhen&&e.when<this.loopEnd)for(var t=1;t<this._loopRemain();++t)this._sampleStart(e,t*this.loopDuration-(this.currentTime()-this.loopWhen),this.loopWhen,this.loopEnd)}}),gswaComposition.prototype.render=function(){var e,t,i,n,s=this,o=this.duration;if(o)return this.stop(),this.isLooping&&(i=this.loopWhen,n=this.loopDuration),e=this.wCtx.ctx,t=this.wCtx.ctx=new OfflineAudioContext(2,44100*o,44100),this.samples.forEach(function(e){e.stop(),e.connect(t.destination)}),this.currentTime(0),n&&this.loop(!1),this.play(),t.startRendering().then(function(t){var o=new DataView(gswaEncodeWAV(t)),a=new Blob([o],{type:"audio/wav"});return s.wCtx.ctx=e,s.samples.forEach(function(t){t.stop(),t.connect(e.destination)}),n&&s.loop(i,n),a}).catch(function(e){console.error("gs-webaudio-library: composition.render() just failed: "+e)})},gswaFramework.do={},gswaFramework.do.addSource=function(e){var t=new gswaBufferSample;e.bufferSample=t,t.setContext(this.audiocontext),t.setMetadata(e.metadata),this.sources.push(e),e.userData=this.on.addSource(e)},gswaFramework.do.addSources=function(e){e.forEach(this.do.addSource),this.on.addSources(e)},gswaFramework.do.loadSource=function(e){var t=this,i=e.bufferSample,n=e.data;if(n)return("string"==typeof n?i.setDataFromURL(n):i.setDataFromBlob(n)).then(function(){return t.on.loadSource(e),e})},gswaFramework.do.loadSources=function(e){Promise.all(e.map(this.do.loadSource)).then(this.on.loadSources)},gswaFramework.do.addTrack=function(e){this.tracks.push(e),e.userData=this.on.addTrack(e)},gswaFramework.do.removeTrack=function(e){var t=this.tracks.findIndex(function(t){return t===e});t>-1&&(this.tracks.splice(t,1),this.on.removeTrack(e))},gswaFramework.do.addComposition=function(e){this.compositions.push(e),e.userData=this.on.addComposition(e)},gswaFramework.do.removeComposition=function(e){var t=this.compositions.findIndex(function(t){return t===e});t>-1&&(this.compositions.splice(t,1),this.on.removeComposition(e))},gswaFramework.do.loadComposition=function(e){this.currentComposition!==e&&(this.currentComposition=e,this.on.loadComposition(e))},gswaFramework.do.setBPM=function(e){e=Math.max(1,Math.min(e,999.999)),this.sampleGroup.stretch(this.bpm/e),this.bpm=e,this.on.setBPM(e)},gswaFramework.do.unload=function(){var e=this.currentComposition;e&&(this.currentComposition=null,this.on.unload(e))},function(){var e=Handlebars.template,t=Handlebars.templates=Handlebars.templates||{};t._app=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o;return(null!=(o=e.invokePartial(n.visual,t,{name:"visual",data:s,helpers:i,partials:n,decorators:e.decorators}))?o:"")+(null!=(o=e.invokePartial(n.menu,t,{name:"menu",data:s,helpers:i,partials:n,decorators:e.decorators}))?o:"")+(null!=(o=e.invokePartial(n.panel,t,{name:"panel",data:s,helpers:i,partials:n,decorators:e.decorators}))?o:"")+(null!=(o=e.invokePartial(n.grid,t,{name:"grid",data:s,helpers:i,partials:n,decorators:e.decorators}))?o:"")+(null!=(o=e.invokePartial(n.gsuiPopup,t,{name:"gsuiPopup",data:s,helpers:i,partials:n,decorators:e.decorators}))?o:"")},usePartial:!0,useData:!0}),t.bpm=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<div id="bpm" class="border inshadow" title="Beats per minute (Scroll to change)">\n\t<span class="text">\n\t\t<span class="bpmLink">\n\t\t\t<span id="bpmInt"></span>\n\t\t\t<span id="bpmDec"></span>\n\t\t</span>\n\t\t<span class="unit">bpm</span>\n\t</span>\n</div>\n'},useData:!0}),t.clock=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<div id="clock">\n\t<span id="clockMin"></span>\n\t<span id="clockSec"></span>\n\t<span id="clockMs"></span>\n\t<span id="clockUnits" href="#">\n\t\t<span class="s">sec</span>\n\t\t<span class="b">beat</span>\n\t</span>\n</div>\n'},useData:!0}),t.grid=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o;return'<div id="grid">\n\t<div id="gridEm">\n\t\t<div id="gridHeader">\n'+(null!=(o=e.invokePartial(n.timeline,t,{name:"timeline",data:s,indent:"\t\t\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+'\t\t</div>\n\t\t<div id="tracks">\n\t\t\t<div id="gridCols">\n\t\t\t\t<div id="tracksNames" class="colA">\n\t\t\t\t\t<div class="extend" data-mousemove-fn="trackNames"></div>\n\t\t\t\t</div>\n\t\t\t\t<div id="gridColB">\n\t\t\t\t\t<div id="tracksBg"></div>\n\t\t\t\t\t<div id="tracksLines">\n\t\t\t\t\t\t<div id="currentTimeCursor"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n'},usePartial:!0,useData:!0}),t.gridBlockSample=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o,a;return'<div class="gridBlock sample">\n\t<div class="content">\n'+(null!=(o=e.invokePartial(n.gsuiWaveform,t,{name:"gsuiWaveform",data:s,indent:"\t\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+'\t</div>\n\t<div class="header">\n\t\t<i class="icon music"></i>\n\t\t<b class="name gsui-textOverflow">'+e.escapeExpression((a=null!=(a=i.name||(null!=t?t.name:t))?a:i.helperMissing,"function"==typeof a?a.call(null!=t?t:e.nullContext||{},{name:"name",hash:{},data:s}):a))+'</b>\n\t</div>\n\t<div class="crop start"></div>\n\t<div class="crop end"></div>\n</div>\n'},usePartial:!0,useData:!0}),t.historyAction=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o,a,r=null!=t?t:e.nullContext||{},l=i.helperMissing,u=e.escapeExpression;return'<a class="task">\n\t<i class="icon fw circle"></i\n\t><i class="icon fw tool tool-'+u((a=null!=(a=i.name||(null!=t?t.name:t))?a:l,"function"==typeof a?a.call(r,{name:"name",hash:{},data:s}):a))+'"></i\n\t><b class="title">'+u((a=null!=(a=i.name||(null!=t?t.name:t))?a:l,"function"==typeof a?a.call(r,{name:"name",hash:{},data:s}):a))+'</b\n\t><span class="text">'+(null!=(a=null!=(a=i.desc||(null!=t?t.desc:t))?a:l,o="function"==typeof a?a.call(r,{name:"desc",hash:{},data:s}):a)?o:"")+"</span>\n</a>\n"},useData:!0}),t.itemBuffer=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o,a;return'<a class="item buffer" draggable="true">\n'+(null!=(o=e.invokePartial(n.gsuiWaveform,t,{name:"gsuiWaveform",data:s,indent:"\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+'\t<div class="info text-overflow">\n\t\t<i class="icon fw"></i>\n\t\t<span class="name">'+e.escapeExpression((a=null!=(a=i.name||(null!=t?t.name:t))?a:i.helperMissing,"function"==typeof a?a.call(null!=t?t:e.nullContext||{},{name:"name",hash:{},data:s}):a))+"</span>\n\t</div>\n</a>\n"},usePartial:!0,useData:!0}),t.menu=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o;return'<div id="menu">\n    <span id="btnPlay" class="btn2 border inshadow icon play" title="Play/pause (press Space, hold Ctrl for pause)"></span>\n    <span id="btnStop" class="btn2 border inshadow icon stop" title="Stop (press Space)"></span> '+(null!=(o=e.invokePartial(n.bpm,t,{name:"bpm",data:s,helpers:i,partials:n,decorators:e.decorators}))?o:"")+" "+(null!=(o=e.invokePartial(n.save,t,{name:"save",data:s,helpers:i,partials:n,decorators:e.decorators}))?o:"")+'\n    <a data-option="magnet" id="btnMagnet" class="btn2 small icon fw magnet" title="Toggle magnetism (press G)"></a>\n    <div class="sep"></div>\n    <a data-tool="select" class="btn2 small icon fw tool-select" title="Select (hold Shift or press V)"></a>\n    <a data-tool="paint" class="btn2 small icon fw tool-paint" title="Paint (press B)"></a>\n    <a data-tool="delete" class="btn2 small icon fw tool-delete" title="Delete (press D)"></a>\n    <a data-tool="mute" class="btn2 small icon fw tool-mute" title="Mute (press M)" style="display: none;"></a>\n    <a data-tool="slip" class="btn2 small icon fw tool-slip" title="Slip (press S)"></a>\n    <a data-tool="cut" class="btn2 small icon fw tool-cut" title="Cut (press C)"></a>\n    <a data-tool="hand" class="btn2 small icon fw tool-hand" title="Hand (hold Alt or press H)"></a>\n    <a data-tool="zoom" class="btn2 small icon fw tool-zoom" title="Zoom (hold Ctrl or press Z)"></a>\n    <div class="flex1"></div>\n\n    <span class="text" style="margin-right: 10px;" id="accountArea_SignedOut">\n        <button type="button" class="btn btn-primary btn-sm" id="btnLogin" data-toggle="modal" data-target="#loginModal" style="background: #214656; margin-right: 10px;"> Login </button>\n        <button type="button" class="btn btn-primary btn-sm"  id="btnRegister" data-toggle="modal" data-target="#registerModal" style="background: #214656"> Register </button>\n    </span>\n\n    <span class="text" style="margin-right: 10px;" id="accountArea_SignedIn">\n        <span id="loggedInUsername"></span>\n    <button type="button" class="btn btn-primary btn-sm" id="btnLogout" style="background: #214656"> Logout </button>\n    </span>\n\n    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">\n        <div class="modal-dialog modal-sm" role="document">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <button type="button" class="close" data-dismiss="modal">&times;</button>\n                    <h4 class="modal-title">Login</h4> </div>\n                <div class="modal-body">\n                    <fieldset>\n                        <div class="form-group">\n                            <input class="form-control" placeholder="Username" name="username" type="text" id="lUsername"> </div>\n                        <div class="form-group">\n                            <input class="form-control" placeholder="Password" name="password" type="password" value="" id="lPassword"> </div>\n                        <button class="btn btn-lg btn-success btn-block" id="btnLoginAccount">Login</button>\n                    </fieldset>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">\n        <div class="modal-dialog modal-sm" role="document">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <button type="button" class="close" data-dismiss="modal">&times;</button>\n                    <h4 class="modal-title">Register</h4> </div>\n                <div class="modal-body">\n                    <fieldset>\n                        <div class="form-group">\n                            <input class="form-control" placeholder="Username" name="username" type="text" id="rUsername"> </div>\n                        <div class="form-group">\n                            <input class="form-control" placeholder="E-mail" name="email" type="text" id="rEmail"> </div>\n                        <div class="form-group">\n                            <input class="form-control" placeholder="Password" name="password" type="password" value="" id="rPassword"> </div>\n                        <button class="btn btn-lg btn-success btn-block" id="btnCreateAccount"> Create Account </button>\n                    </fieldset>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>'},usePartial:!0,useData:!0}),t["panel-files"]=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<section id="files">\n    <div class="panel panel-default">\n        <div class="panel-heading">\n            <h3 class="panel-title">Recent Changes</h3>\n        </div>\n        <ul class="list-group">\n            <li class="list-group-item">\n                <div class="row text-center" id="dropdown-detail-1" data-toggle="detail-1">\n                    <div class="col-xs-2">\n                        <div class="row">\n                            <span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span>\n                            <h5>0</h5>\n                            <span class="glyphicon glyphicon-menu-down" aria-hidden="true"></span>\n                        </div>\n                    </div>\n                    <div class="col-xs-10 text-left">\n                        <h5><a>Tonikami</a> added 3 blocks</h5>\n                        <small>3 hours ago</small>\n                    </div>\n                </div>\n            </li>\n            <li class="list-group-item">\n                <div class="row text-center" id="dropdown-detail-1" data-toggle="detail-1">\n                    <div class="col-xs-2">\n                        <div class="row">\n                            <span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span>\n                            <h5>0</h5>\n                            <span class="glyphicon glyphicon-menu-down" aria-hidden="true"></span>\n                        </div>\n                    </div>\n                    <div class="col-xs-10 text-left">\n                        <h5><a>AdibP</a> added 10 blocks</h5>\n                        <small>5 hours ago</small>\n                    </div>\n                </div>\n            </li>\n        </ul>\n    </div>\n    <div>\n        <input id="filesInput" type="file" />\n        <div id="filesCursor" class="cursor"></div>\n        <nav id="filesFilters">\n            <a href="#" class="used">Used</a>\n            <a href="#" class="loaded">Loaded</a>\n            <a href="#" class="unloaded">Unloaded</a>\n        </nav>\n        <div id="filesList" class="list"></div>\n        <div class="placeholder">\n            <i class="icon file-audio"></i>\n            <br/>\n            <b>Drop audio files here</b>\n        </div>\n    </div>\n\n\n</section>'},useData:!0}),t["panel-history"]=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<section id="history">\n\t<nav>\n\t\t<span class="title">History</span>\n\t\t<a id="btnUndo" class="btn icon fw undo" title="Undo (Ctrl + Z)"></a>\n\t\t<a id="btnRedo" class="btn icon fw redo" title="Redo (Ctrl + Shift + Z)"></a>\n\t</nav>\n\t<div id="historyList" class="list"></div>\n</section>\n'},useData:!0}),t.panel=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o;return'<div id="panel">\n\t<div class="extend" data-mousemove-fn="panel"></div>\n'+(null!=(o=e.invokePartial(n["panel-history"],t,{name:"panel-history",data:s,indent:"\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+(null!=(o=e.invokePartial(n["panel-files"],t,{name:"panel-files",data:s,indent:"\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+"</div>\n"},usePartial:!0,useData:!0}),t.save=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<div id="save" class="border">\n\t<span data-edit="save" class="btn2 inshadow icon fw save" title="Save (Ctrl + S)"></span>\n\t<input id="saveCheckbox" type="checkbox"/>\n\t<label for="saveCheckbox"mak></label>\n\t<div class="dropdown">\n\t\t<div class="title">Current composition :</div>\n\t\t<a href="#" id="exportToWaveFile">Export to Wave file</a>\n\t\t<div class="title">All compositions :</div>\n\t\t<div class="list"></div>\n\t</div>\n</div>\n'},useData:!0}),t.saveComposition=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<a href="#" class="saveComposition">\n\t<div class="name"></div>\n\t<span class="bpm"></span>\n\t<span class="duration"></span>\n</a>\n'},useData:!0}),t.timeline=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o;return'<div id="timeline">\n\t<span id="currentTimeArrow" class="icon caret-down"></span>\n'+(null!=(o=e.invokePartial(n.timelineLoop,t,{name:"timelineLoop",data:s,indent:"\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+'\t<div id="timelineBeats"></div>\n</div>\n'},usePartial:!0,useData:!0}),t.timelineBeat=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<span class="timelineBeat">\n\t<span></span>\n</span>\n'},useData:!0}),t.timelineLoop=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){return'<div id="timelineLoop">\n\t<div class="time a"></div>\n\t<div class="time b"></div>\n</div>\n'},useData:!0}),t.track=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o;return'<div class="track">\n'+(null!=(o=e.invokePartial(n.gsuiToggle,t,{name:"gsuiToggle",data:s,indent:"\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+(null!=(o=e.invokePartial(n.gsuiSpanEditable,t,{name:"gsuiSpanEditable",data:s,indent:"\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+"</div>\n"},usePartial:!0,useData:!0}),t.visual=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,s){var o;return'<div id="visual">\n'+(null!=(o=e.invokePartial(n.gsuiOscilloscope,t,{name:"gsuiOscilloscope",data:s,indent:"\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+'\t<div class="columns">\n\t\t<div class="cell-btn"><a id="btnHistory" class="btn2 icon fw history" title="History (undo/redo)"></a></div>\n\t\t<div class="cell-btn"><a id="btnFiles" class="btn2 icon fw files" title="Audio files"></a></div>\n\t\t<div class="cell-clock">\n'+(null!=(o=e.invokePartial(n.clock,t,{name:"clock",data:s,indent:"\t\t\t",helpers:i,partials:n,decorators:e.decorators}))?o:"")+"\t\t</div>\n\t</div>\n</div>\n"},usePartial:!0,useData:!0})}(),window.common={},common.timestampText=function(e,t){var i,n,s;return t?(i=1+~~(e*=t/60),n=1+~~(e*=4)%4):(i=~~(e/60),n=~~(e%60)),n=n<10?"0"+n:n,s=Math.floor(1e3*(e-~~e)),s<10?s="00"+s:s<100&&(s="0"+s),{a:i,b:n,c:s}},common.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},window.waFwk=new gswaFramework,waFwk.on.removeTrack=function(e){lg("removeTrack",e)},waFwk.on.addSource=function(e){lg("addSource",e)},waFwk.on.addSources=function(e){lg("addSources",e)},waFwk.on.loadSource=function(e){lg("loadSource",e)},waFwk.on.loadSources=function(e){lg("loadSources",e)},waFwk.on.addComposition=function(e){lg("addComposition",e)},waFwk.on.removeComposition=function(e){lg("removeComposition",e)},waFwk.on.loadComposition=function(e){lg("loadComposition",e)},waFwk.on.unload=function(e){lg("unload",e)},waFwk.on.play=function(e){lg("play",e)},waFwk.on.pause=function(e){lg("pause",e)},waFwk.on.stop=function(e){lg("stop",e)},waFwk.on.save=function(e){lg("save",e)},waFwk.on.render=function(e){lg("render",e)},waFwk.on.pause=function(e){lg("pause",e)},function(){function e(){var e=this;this.id=waFwk.tracks.length-1,this.name="",this.samples=[],this.elColNamesTrack=ui.createHTML(Handlebars.templates.track())[0],this.elColLinesTrack=ui.createHTML("<div class='track'>")[0],this.elColNamesTrack.uitrack,this.elColLinesTrack.uitrack=this,this.wfilters=gs.wctx.createFilters(),ui.dom.tracksNames.appendChild(this.elColNamesTrack),ui.dom.tracksLines.appendChild(this.elColLinesTrack),this.gsuiToggle=new gsuiToggle(this.elColNamesTrack.querySelector(".gsuiToggle"),{onchange:function(t){e.isOn=t,e.wfilters.gain(+t),e.elColNamesTrack.classList.toggle("off",!t),e.elColLinesTrack.classList.toggle("off",!t)}}),this.gsuiSpanEditable=new gsuiSpanEditable(this.elColNamesTrack.querySelector(".gsuiSpanEditable"),{onchange:function(t){e.name=t}}),waFwk.tracks.length>1&&this.gsuiToggle.groupWith(waFwk.tracks[0].userData.gsuiToggle),this.gsuiSpanEditable.setPlaceholder("Track "+(this.id+1)),this.toggle(!0),this.editName("")}waFwk.on.addTrack=function(t){return new e},e.prototype={toggle:function(e){this.gsuiToggle.toggle(e)},editName:function(e){this.gsuiSpanEditable.setValue(e)},removeSample:function(e){var t=this.samples.indexOf(e);t>-1&&this.samples.splice(t,1)}}}(),window.gs={compositions:{},file:{},files:[],sample:{},samples:{selected:{}},selectedSamples:[]},function(){var e,t,i,n=-1,s=-1;gs.loop=e={reorderTimeAB:function(){n>=0&&s>=0&&(n=gs.composition.loopWhen,s=n+gs.composition.loopDuration)},timeA:function(t){lg("timea"),n=t,e.update()},timeB:function(t){lg("timeb"),s=t,e.update()},stop:function(){n=s=-1,gs.composition.loop(!1),ui.timelineLoop.toggle(!1)},update:function(){if(n>=0&&s>=0){var e,o=Math.min(n,s),a=Math.abs(s-n);o===t&&a===i||(t=o,i=a,(e=a>.01)&&(gs.composition.loop(o,a),ui.timelineLoop.when(o),ui.timelineLoop.duration(a)),ui.timelineLoop.toggle(e))}}}}(),gs.playStop=function(){(gs.isPlaying?gs.stop:gs.play)()},gs.playPause=function(){(gs.composition.isPlaying?gs.pause:gs.play)()},gs.play=function(){gs.file.stop(),!gs.composition.isPlaying&&gs.composition.samples.length&&(gs.composition.play(),gs.composition.isPlaying&&(gs.isPaused=!(gs.isPlaying=!0),ui.btnPlay.play()))},gs.pause=function(){gs.file.stop(),gs.composition.isPlaying&&(gs.composition.pause(),gs.isPaused=!(gs.isPlaying=!1),ui.btnPlay.pause())},gs.stop=function(){gs.file.stop(),gs.compositionStop()},gs.compositionStop=function(){gs.composition.stop(),gs.currentTime(0),gs.isPaused=gs.isPlaying=!1,ui.btnStop.stop()},gs.file.click=function(e){e.isLoaded?gs.file.play(e):e.file?e.isLoading||gs.file.load(e,gs.file.play):ui.gsuiPopup.open("confirm","Sample's data missing","<code>"+e.name+"</code> is missing...<br/>Do you want to browse your files to find it ?").then(function(t){t&&ui.filesInput.getFile(function(t){gs.file.joinFile(e,t)})})},gs.file.create=function(e){var t={id:gs.files.length,wbuff:gs.wctx.createBuffer(),isLoaded:!1,isLoading:!1,nbSamples:0,samplesToSet:[],file:e.length?null:e,bufferDuration:e.length?e[3]:null,fullname:e.name||e[1]};return t.wbuff.sample.onended(gs.file.stop),t.name=t.fullname.replace(/\.[^.]+$/,""),t.elFile=ui.createHTML(Handlebars.templates.itemBuffer(t))[0],t.elName=t.elFile.querySelector(".name"),t.elIcon=t.elFile.querySelector(".icon"),t.file?ui.file.unloaded(t):(t.size=e[2],ui.file.withoutData(t)),t.elFile.onclick=gs.file.click.bind(null,t),t.elFile.ondragstart=gs.file.dragstart.bind(null,t),t.elFile.oncontextmenu=function(){return!1},t.elFile.onmousedown=function(e){0!==e.button&&gs.file.stop(),e.ctrlKey&&gs.file.delete(t)},gs.files.push(t),ui.dom.filesList.appendChild(t.elFile),t},gs.file.delete=function(e){gs.composition.samples.filter(function(t){return t.data.gsfile===e}).forEach(function(e){gs.sample.delete(e)}),gs.files.splice(gs.files.indexOf(e),1),e.elFile.remove()},gs.file.joinFile=function(e,t){var i=e.wbuff;ui.file.unloaded(e),e.fullname!==t.name&&(e.fullname=t.name,e.name=e.fullname.replace(/\.[^.]+$/,""),e.elName.textContent=e.name),e.file=t,gs.file.load(e,function(e){i.samples.forEach(function(t){t.data.elName.textContent=e.name,ui.sample.duration(t)})})},gs.file.load=function(e,t){e.isLoading=!0,ui.file.loading(e),e.wbuff.setFile(e.file).then(function(i){var n=new gsuiWaveform(e.elFile.querySelector(".gsuiWaveform")),s=i.buffer,o=s.duration,a=s.getChannelData(0),r=s.numberOfChannels<2?a:s.getChannelData(1);e.isLoaded=!0,e.isLoading=!1,e.gsuiWaveform=n,n.setResolution(250,40),n.draw(a,r,o,0,o),ui.file.loaded(e),t(e)},function(){e.isLoading=!1,ui.file.error(e),ui.gsuiPopup.open("warning","Unknown file format","At this day, the file <code>"+e.fullname+"</code> can not be decoded by your browser.\n")})},gs.file.play=function(e){var t=gs.file.playingSmp;t&&t.stop(),e.isLoaded&&(ui.filesCursor.insertInto(e),gs.file.playingSmp=e.wbuff.sample.start(),setTimeout(ui.filesCursor.startMoving.bind(null,e.wbuff.buffer.duration),20))},gs.file.stop=function(){var e=gs.file.playingSmp;e&&(e.stop(),ui.filesCursor.remove())},function(){gs.history={reset:function(){t.length=0,e=-1,ui.historyList.reset()},goToAction:function(t){var i=t.id-e+1;if(i<0)for(;i++;)gs.history.undo();else if(i>0)for(;i--;)gs.history.redo()},push:function(i,n){var s={id:e,name:i,fn:gs.history[i],data:n};e<t.length-1&&t.splice(e+1),t.push(s),ui.historyList.push(s),++e},pushExec:function(e,t){gs.history.push(e,t),gs.history[e](t,1)},undo:function(){if(e>-1){var i=t[e--];i.fn&&i.fn(i.data,-1),ui.historyList.undo()}},redo:function(){if(e<t.length-1){var i=t[++e];i.fn&&i.fn(i.data,1),ui.historyList.redo()}}};var e,t=[]}(),function(){function e(e,t){t>0?(e.selected.forEach(function(e){gs.sample.select(e,!1)}),e.pasted.forEach(function(t,i){var n=e.copied[i];gs.sample.inTrack(t,n.data.track.id),gs.sample.when(t,n.when+e.allDuration),gs.sample.slip(t,n.offset),gs.sample.duration(t,n.duration),gs.sample.select(t,!0)}),gs.composition.add(e.pasted)):(e.pasted.forEach(gs.sample.delete),e.selected.forEach(function(e){gs.sample.select(e,!0)}))}function t(e,t){var i,n=e.duration;e.samples.forEach(function(s,o){i=e.newSamples[o],t>0?(gs.sample.inTrack(i,s.data.track.id),gs.sample.when(i,s.when+n),gs.sample.slip(i,s.offset+n),gs.sample.duration(i,s.duration-n),gs.sample.duration(s,n),gs.composition.add(i)):(gs.sample.duration(s,n+i.duration),gs.sample.delete(i)),gs.composition.update(s)})}function i(e){e.samples.forEach(function(e){gs.sample.select(e)})}function n(e,t){var i=e.sample;t>0?(gs.sample.inTrack(i,e.track.id),gs.sample.when(i,e.when),gs.composition.add(i)):gs.sample.delete(i)}function s(e,t){t>0?e.samples.forEach(gs.sample.delete):e.samples.forEach(function(e){gs.sample.inTrack(e,e.data.track.id),gs.sample.when(e,e.when),gs.sample.slip(e,e.offset),gs.sample.duration(e,e.duration),gs.sample.select(e,e.data.oldSelected),gs.composition.add(e),e.data.gsfile.nbSamples++||ui.file.used(e.data.gsfile)})}function o(e,t){var i=e.sample,n=e.track*t;gs.samples.selected.when(i,e.when*t),n&&(i.data.selected?gs.selectedSamples.forEach(function(e){gs.sample.inTrack(e,e.data.track.id+n)}):gs.sample.inTrack(i,i.data.track.id+n)),gs.samples.selected.do(i,function(e){gs.composition.update(e,"mv")})}function a(e,t){var i=e.sample;gs.samples.selected.duration(i,e.duration*t),gs.samples.selected.when(i,e.when*t),gs.samples.selected.slip(i,-e.offset*t),gs.samples.selected.do(i,function(e){gs.composition.update(e,"mv")})}function r(e,t){gs.samples.selected.duration(e.sample,e.duration*t),gs.samples.selected.do(e.sample,function(e){gs.composition.update(e,"mv")})}function l(e,t){gs.samples.selected.slip(e.sample,e.offset*t),gs.samples.selected.do(e.sample,function(e){gs.composition.update(e,"mv")})}Object.assign(gs.history,{select:i,create:n,delete:s,move:o,crop:a,cropEnd:r,slip:l,paste:e,cut:t})}(),function(){var e=[],t="click mousedown mouseup mousemove change".split(" ");window.ui={dom:{},initElement:function(t,i){return e.push({name:t,fn:i}),ui},createHTML:function(e){var t=document.createElement("div");return t.innerHTML=e,Array.from(t.children)},init:function(i,n,s){function o(e){e.id&&(ui.dom[e.id]=e)}var a,r=Handlebars.templates;for(a in r)a!==n&&Handlebars.registerPartial(a,r[a]);i.innerHTML=r[n](s),function e(t){for(var i,n=t.firstChild;null!==n;)e(i=n),n=n.nextSibling,1!==i.nodeType&&/^\s*$/.test(i.textContent)&&t.removeChild(i)}(i),o(i),Array.from(i.querySelectorAll("[id]")).forEach(o),e.forEach(function(e){var i,n=ui.dom[e.name],s=e.fn(n);ui[e.name]=s;for(i in s)t.indexOf(i)>-1&&n.addEventListener(i,s[i])})}}}(),ui.initElement("btnLoginAccount",function(){return{click:function(){var e={username:ui.dom.lUsername.value,password:ui.dom.lPassword.value},t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){t.responseText;location.reload()}},t.open("POST","/auth/login",!0),t.setRequestHeader("Content-type","application/json"),t.send(JSON.stringify(e))}}}),ui.initElement("btnCreateAccount",function(){return{click:function(){var e=ui.dom.rUsername.value,t=ui.dom.rEmail.value,i={username:e,password:ui.dom.rPassword.value,email:t},n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){n.responseText;location.reload()}},n.open("POST","/auth/signup",!0),n.setRequestHeader("Content-type","application/json"),n.send(JSON.stringify(i))}}}),ui.initElement("btnLogout",function(){return{click:function(){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&200==e.status&&location.reload()},e.open("GET","/auth/logout",!0),e.send()}}}),ui.initElement("bpm",function(e){function t(e,t){var n=t.deltaY;t.preventDefault(),ui.bpm.set(ui._bpm+(n>0?-e:n?e:0)),clearTimeout(i),i=setTimeout(gs.bpm.bind(null,ui._bpm),400)}var i;return ui.dom.bpmInt.onwheel=t.bind(null,1),ui.dom.bpmDec.onwheel=t.bind(null,.01),ui.dom.bpm.ondblclick=function(){ui.gsuiPopup.open("prompt","BPM","Choose your BPM (20-999) :",gs._bpm).then(function(e){+e&&gs.bpm(+e)})},{set:function(e){var t=~~e,i=Math.min(Math.round(100*(e-t)),99);ui._bpm=e,ui.dom.bpmInt.textContent=t<100?"0"+t:t,ui.dom.bpmDec.textContent=i<10?"0"+i:i}}}),ui.isMagnetized=!1,ui.initElement("btnMagnet",function(e){function t(t){"boolean"!=typeof t&&(t=!ui.isMagnetized),ui.isMagnetized=t,e.classList.toggle("active",t)}return{click:t,toggle:t}}),ui.initElement("btnPlay",function(e){function t(){var e=gs.composition.currentTime();ui.currentTimeCursor.at(e),ui.clock.setTime(e),i=requestAnimationFrame(t)}var i;return{click:gs.playPause,play:function(){e.classList.remove("play"),e.classList.add("pause"),t()},pause:function(){cancelAnimationFrame(i),e.classList.remove("pause"),e.classList.add("play")}}}),ui.initElement("btnStop",function(e){return{click:gs.stop,stop:function(){ui.btnPlay.pause(),ui.currentTimeCursor.at(0),ui.clock.setTime(0)}}}),ui.initElement("btnUndo",function(){return{click:gs.history.undo}}),ui.initElement("btnRedo",function(){return{click:gs.history.redo}}),ui.initElement("clock",function(e){return{setUnit:function(e){ui.dom.clockUnits.dataset.unit=e,ui.clock.setTime(gs.currentTime())},setTime:function(e){var t=common.timestampText(e,"s"!==gs.clockUnit&&gs._bpm);ui.dom.clockMin.textContent=t.a,ui.dom.clockSec.textContent=t.b,ui.dom.clockMs.textContent=t.c}}}),ui.initElement("currentTimeCursor",function(e){var t=ui.dom.currentTimeArrow;return{at:function(i){i>0&&(e.style.left=t.style.left=i*ui.BPMem+"em"),e.classList.toggle("visible",i>0),t.classList.toggle("visible",i>0)}}}),ui.initElement("exportToWaveFile",function(e){return{click:function(e){var t=gs.composition.render();e.preventDefault(),t&&t.then(function(e){var t=gs.compositions.current;ui.exportToWaveFile.downloadFile((t?t.name:"untitled")+".wav",e)})},downloadFile:function(e,t){var i=document.createElement("a"),n=URL.createObjectURL(t);i.download=e,i.href=n,i.click(),URL.revokeObjectURL(n)}}}),ui.initElement("filesCursor",function(e){return{remove:function(){e.remove()},insertInto:function(t){e.style.transitionDuration=e.style.left=0,t.elFile.appendChild(e)},startMoving:function(t){e.style.transitionDuration=t+"s",e.style.left="100%"}}}),ui.initElement("filesInput",function(e){var t;return{change:function(){t(e.files[0])},getFile:function(i){t=i,e.click()}}}),ui.initElement("historyList",function(e){var t,i=[];return{click:function(e){(e=e.target.historyAction)&&gs.history.goToAction(e)},reset:function(){for(t=0,i.length=0;e.hasChildNodes();)e.lastChild.remove()},undo:function(){i[--t].classList.add("undone")},redo:function(){i[t++].classList.remove("undone")},push:function(n){for(var s=i.length-t,o=ui.createHTML(Handlebars.templates.historyAction(n))[0];s-- >0;)i.pop().remove();t++,o.historyAction=n,i.push(o),e.appendChild(o),e.scrollTop=1e9}}}),ui.initElement("save",function(e){var t={},i=e.querySelector(".list");return{click:function(e){var t=e.target;e.stopPropagation(),t.classList.contains("save")&&gs.compositions.saveCurrent()},hideList:function(){ui.dom.saveCheckbox.checked=!1},unselectComposition:function(){var e=i.firstChild;e&&e.classList.remove("selected")},selectComposition:function(e){var n=t[e.id].root;ui.save.unselectComposition(),n.classList.add("selected"),i.insertBefore(n,i.firstChild)},addComposition:function(e){var n=ui.createHTML(Handlebars.templates.saveComposition())[0];n.onclick=function(){return gs.reset(),gs.compositions.load(e),window.setTimeout(ui.save.hideList,200),!1},t[e.id]={root:n,name:n.querySelector(".name"),bpm:n.querySelector(".bpm"),duration:n.querySelector(".duration")},ui.save.updateComposition(e),i.appendChild(n)},updateComposition:function(e){var i=t[e.id],n=common.timestampText(e.duration);i.name.textContent=e.name,i.bpm.textContent=e.bpm,i.duration.textContent=n.a+":"+n.b+"."+n.c}}}),ui.initElement("timeline",function(){var e;return{mousedown:function(t){var i=Date.now();i-e<250&&(gs.loop.stop(),gs.loop.timeA(ui.getGridSec(t.pageX)),ui.timelineLoop.clickTime("b")),e=i},mouseup:function(e){ui.timelineLoop.dragging||gs.currentTime(ui.getGridSec(e.pageX))},update:function(){var e=ui.trackLinesLeft/ui.gridEm,t=ui.trackLinesWidth/ui.gridEm;ui.timelineBeats.fill(Math.ceil(-e+t)),ui.dom.timelineBeats.style.marginLeft=e+="em",ui.dom.currentTimeArrow.style.marginLeft=e,ui.dom.timelineLoop.style.marginLeft=e}}}),ui.initElement("timelineBeats",function(e){var t=0;return{fill:function(i){if(i>t){var n=t;for(t=i;n++<i;)e.appendChild(ui.createHTML(Handlebars.templates.timelineBeat())[0])}}}}),ui.initElement("timelineLoop",function(e){var t,i;return document.body.addEventListener("mousemove",function(e){i&&i(ui.getGridSec(e.pageX))}),document.body.addEventListener("mouseup",function(){i&&(i=null,t.dragging=!1,ui.cursor("app",null))}),t={mousedown:function(e){var i=e.target;i.classList.contains("time")&&(t.clickTime(i.classList.contains("a")?"a":"b"),e.stopPropagation())},clickTime:function(e){i="a"===e?gs.loop.timeA:gs.loop.timeB,gs.loop.reorderTimeAB(),t.dragging=!0,ui.cursor("app","w-resize")},toggle:function(t){e.classList.toggle("hidden",!t)},when:function(t){e.style.left=t*ui.BPMem+"em"},duration:function(t){e.style.width=t*ui.BPMem+"em"}}}),ui.initElement("tracksBg",function(e){function t(t){var s,o,a,r,l,u=t-n;for(n=Math.max(t,n),s=0;s<u;++s){for(r=document.createElement("div"),o=0;o<4;++o){for(l=document.createElement("div"),a=0;a<4;++a)l.appendChild(document.createElement("div"));r.appendChild(l)}e.appendChild(r)}i=i||e.firstChild}var i,n=0;return{update:function(){t(Math.ceil(ui.trackLinesWidth/ui.gridEm/4)+2),i.style.marginLeft=ui.trackLinesLeft/ui.gridEm%8+"em"}}}),ui.initElement("visual",function(e){var t=new gsuiOscilloscope(e.querySelector(".gsuiOscilloscope"));return t.setResolution(256,e.clientHeight),t.setPinch(1),t.dataFunction(function(){return gs.analyserNode.getByteTimeDomainData(gs.analyserData),gs.analyserData}),t.drawBegin(function(e,t,i,n){e.globalCompositeOperation="source-in",e.fillStyle="rgba(0,0,0,.8)",e.fillRect(0,0,i,n),e.globalCompositeOperation="source-over"}),t.drawEnd(function(e,t){t<.01?e.strokeStyle="rgba(0,0,0,0)":(e.strokeStyle="#52666e",e.lineJoin="round",e.lineWidth=2)}),{on:t.startAnimation.bind(t),off:t.stopAnimation.bind(t)}}),ui.init(document.querySelector("#app"),"_app",{}),ui.dom.toolBtns=Array.from(ui.dom.menu.querySelectorAll(".btn2[data-tool]")),ui.tool={},ui.tracks=[],ui.gridEm=parseFloat(getComputedStyle(ui.dom.grid).fontSize),ui.gridColsY=ui.dom.gridCols.getBoundingClientRect().top,ui.gsuiPopup=new gsuiPopup(document.querySelector(".gsuiPopup")),function(){function e(e,t){t?e.dataset.cursor=t:e.removeAttribute("data-cursor")}var t=null;ui.cursor=function(i,n){"app"===i?(e(ui.dom.app,n),e(ui.dom.tracksLines,n?null:t)):e(ui.dom.tracksLines,t=n)}}(),function(){function e(e,t){return Math.abs(e-t)<1e-4}function t(e){var t=e%i;return e-=t,t>n&&(e+=i),e}ui.getGridSec=function(e){var i=(e-ui.filesWidth-ui.trackNamesWidth-ui.trackLinesLeft)/ui.gridEm;return(ui.isMagnetized?t(i):i)/ui.BPMem},ui.secFloor=function(n){var s=n*ui.BPMem,o=t(s);return(o<s||e(o,s)?o:o-i)/ui.BPMem},ui.secCeil=function(n){var s=n*ui.BPMem,o=t(s);return(o>s||e(o,s)?o:o+i)/ui.BPMem};var i=.25,n=i/2}(),ui.getTrackFromPageY=function(e){return waFwk.tracks[Math.floor((e-ui.gridColsY+ui.gridScrollTop)/ui.trackHeight)].userData},ui.file={unloaded:function(e){e.elIcon.classList.add("ramload"),e.elIcon.classList.remove("question"),e.elFile.classList.add("unloaded")},loading:function(e){e.elIcon.classList.add("loading"),e.elIcon.classList.remove("ramload")},loaded:function(e){e.elFile.classList.add("loaded"),e.elFile.classList.remove("unloaded"),e.elIcon.remove()},withoutData:function(e){e.elIcon.classList.add("question"),e.elIcon.classList.remove("ramload"),e.elFile.classList.add("unloaded")},error:function(e){e.elIcon.classList.add("cross"),e.elIcon.classList.remove("loading")},used:function(e){e.elFile.classList.add("used")},unused:function(e){e.elFile.classList.remove("used")}},ui.panelSection=function(e){ui.dom.app.dataset.panel=e},ui.resize=function(){ui.screenWidth=document.body.clientWidth,ui.screenHeight=document.body.clientHeight,ui.gridColsWidth=ui.dom.gridCols.getBoundingClientRect().width,ui.gridColsHeight=ui.dom.tracks.clientHeight,ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,ui.timeline.update(),ui.tracksBg.update()},ui.sample={create:function(e){var t=ui.createHTML(Handlebars.templates.gridBlockSample(e.data.gsfile))[0];e.data.elSmp=t,e.data.elWave=t.querySelector(".gsuiWaveform"),e.data.elName=t.querySelector(".name"),e.data.elCropStart=t.querySelector(".crop.start"),e.data.elCropEnd=t.querySelector(".crop.end"),e.data.gsuiWaveform=new gsuiWaveform(e.data.elWave),Array.from(t.querySelectorAll("*")).forEach(function(t){t.gsSample=e})},delete:function(e){e.data.elSmp.remove()},select:function(e){e.data.elSmp.classList.toggle("selected",e.data.selected)},inTrack:function(e){e.data.track.elColLinesTrack.appendChild(e.data.elSmp)},when:function(e){e.data.elSmp.style.left=e.when*ui.BPMem+"em"},duration:function(e){e.data.elSmp.style.width=e.duration*ui.BPMem+"em",ui.sample.waveform(e)},waveform:function(e){var t=e.wBuffer.buffer;if(t){var i=e.offset,n=Math.min(e.duration,t.duration-i),s=n*ui.BPMem,o=e.data.gsuiWaveform,a=t.getChannelData(0),r=t.numberOfChannels<2?a:t.getChannelData(1);e.data.elWave.style.width=s+"em",o.setResolution(~~(1024*n),128),o.draw(a,r,t.duration,i,n)}}},ui.selectTool=function(){var e;return function(t){var i,n=ui.dom.toolBtns.tool[t];n!==e&&(e&&(e.classList.remove("active"),(i=ui.tool[ui.currentTool]).mouseup&&i.mouseup({}),i.end&&i.end()),e=n,n.classList.add("active"),ui.dom.grid.dataset.tool=ui.currentTool=t,(i=ui.tool[t]).start&&i.start())}}(),ui.setFilesWidth=function(e){ui.dom.panel.style.width=e+"px",ui.filesWidth=e=ui.dom.panel.clientWidth,ui.gridColsWidth=ui.screenWidth-e,ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,ui.dom.grid.style.left=e+"px",ui.dom.visual.style.width=ui.dom.menu.style.left=e+ui.trackNamesWidth+"px",ui.timeline.update(),ui.tracksBg.update()},ui.gridScrollTop=0,ui.setGridScrollTop=function(e){ui.dom.gridCols.scrollTop=ui.gridScrollTop=e<=0?0:Math.min(e,waFwk.tracks.length*ui.gridEm-ui.gridColsHeight),ui.updateGridTopShadow()},ui.gridZoom=1,ui.setGridZoom=function(e,t){var i=(e=Math.min(Math.max(1,e),8))/ui.gridZoom;ui.gridZoom=e,ui.gridEm*=i,ui.dom.gridEm.style.fontSize=e+"em",ui.dom.grid.dataset.sampleSize=ui.gridEm<40?"small":ui.gridEm<80?"medium":"big",ui.setTrackLinesLeft(t-(-ui.trackLinesLeft+t)*i),ui.timeline.update(),ui.tracksBg.update()},ui.setTrackLinesLeft=function(e){ui.trackLinesLeft=e=Math.min(~~e,0),ui.dom.tracksLines.style.marginLeft=e/ui.gridEm+"em",ui.updateGridLeftShadow()},ui.trackNamesWidth=0,ui.setTrackNamesWidth=function(e){var t,i=ui.trackNamesWidth;ui.dom.tracksNames.style.width=e+"px",ui.trackNamesWidth=e=ui.dom.tracksNames.getBoundingClientRect().width,ui.trackLinesWidth=ui.gridColsWidth-e,t=ui.filesWidth+e,ui.dom.gridColB.style.left=ui.dom.timeline.style.left=e+"px",ui.dom.visual.style.width=ui.dom.menu.style.left=t+"px",ui.trackLinesLeft<0&&ui.setTrackLinesLeft(ui.trackLinesLeft-(e-i)),ui.timeline.update(),ui.tracksBg.update()},function(){var e="px 2px rgba(0,0,0,.3)";ui.updateGridLeftShadow=function(){ui.dom.tracksNames.style.boxShadow=ui.trackLinesLeft?Math.min(2-ui.trackLinesLeft/8,5)+"px 0"+e:"none"},ui.updateGridTopShadow=function(){ui.dom.gridHeader.style.boxShadow=ui.gridScrollTop?"0px "+Math.min(2+ui.gridScrollTop/8,5)+e:"none"}}(),ui.BPMem=1,gs.bpm=function(e){if(!arguments.length)return gs._bpm;gs.composition.bpm(Math.max(20,Math.min(e,999))),gs._bpm=gs.composition.bpm(),ui.bpm.set(gs._bpm),ui.BPMem=gs._bpm/60,gs.composition.samples.forEach(ui.sample.duration),ui.clock.setTime(gs.currentTime())},gs.currentTime=function(e){if(!arguments.length)return gs.composition.currentTime();gs.composition.currentTime(e),e=gs.composition.currentTime(),ui.currentTimeCursor.at(e),ui.clock.setTime(e)},gs.reset=function(){return delete gs.compositions.current,waFwk.tracks.forEach(function(e){e.userData.editName(""),e.userData.toggle(!0)}),gs.composition.samples.forEach(function(e){gs.sample.select(e,!0)}),gs.samples.selected.delete(),gs.files.forEach(function(e){e.elFile.remove()}),gs.files=[],gs.history.reset(),ui.save.unselectComposition(),this},function(){document.body.addEventListener("mousemove",function(i){e&&(t.style.left=i.pageX+"px",t.style.top=i.pageY+"px")}),document.body.addEventListener("mouseup",function(i){e&&(t.remove(),e=null,ui.cursor("app",null))}),ui.dom.gridColB.addEventListener("mouseup",function(t){e&&gs.history.pushExec("create",{sample:gs.sample.create(e),track:ui.getTrackFromPageY(t.pageY),when:ui.getGridSec(t.pageX)})}),gs.file.dragstart=function(i,n){return i.isLoaded&&!e&&(e=i,(t=i.elFile.cloneNode(!0)).style.left=n.pageX+"px",t.style.top=n.pageY+"px",t.classList.add("dragging"),ui.dom.app.appendChild(t),ui.cursor("app","grabbing")),!1};var e,t}(),gs.compositions.init=function(){var e=localStorage.compositions;(gs.compositions.list=e?JSON.parse(e):[]).forEach(function(e){ui.save.addComposition(e)})},gs.compositions.load=function(e){gs.compositions.current=e,gs.bpm(e.bpm),e.files.forEach(gs.file.create),e.tracks.forEach(function(e){for(var t,i=e[0];i>=waFwk.tracks.length;)waFwk.do.addTrack({});(t=waFwk.tracks[i].userData).toggle(e[1]),t.editName(e[2])}),e.samples.forEach(function(e){var t=gs.sample.create(gs.files[e[1]]);t.data.gsfile.samplesToSet.push(t),gs.sample.inTrack(t,e[0]),gs.sample.when(t,e[2]/ui.BPMem),gs.sample.slip(t,e[3]/ui.BPMem),gs.sample.duration(t,e[4]/ui.BPMem),gs.composition.add(t)}),ui.save.selectComposition(e)},gs.compositions.readFile=function(e){return new Promise(function(t,i){if(e){var n=new FileReader;n.onload=function(e){var i=JSON.parse(e.target.result);gs.compositions.store(i),gs.compositions.load(i),t()},n.readAsText(e)}else t()})},gs.compositions.saveCurrent=function(){gs.compositions.save(gs.compositions.current)},gs.compositions.save=function(e){function t(e){gs.compositions.current=e,gs.compositions.serialize(e),gs.compositions.store(e),ui.save.selectComposition(e)}e?t(e):ui.gsuiPopup.open("prompt","Composition's name","Please enter a name for your new composition :").then(function(e){e&&t({name:e.trim()})})},gs.compositions.serialize=function(e){e.bpm=gs._bpm,e.duration=gs.composition.duration,e.files=gs.files.map(function(e){return[e.id,e.fullname,e.file?e.file.size:e.size,e.wbuff.buffer?e.wbuff.buffer.duration:e.bufferDuration]}),e.samples=gs.composition.samples.map(function(e){return[e.data.track.id,e.data.gsfile.id,ui.BPMem*e.when,ui.BPMem*e.offset,ui.BPMem*e.duration]}),e.tracks=waFwk.tracks.reduce(function(e,t){var i=t.userData;return(!i.isOn||i.samples.length||i.name||i.wfilters&&i.wfilters.length)&&e.push([i.id,i.isOn,i.name]),e},[])},gs.compositions.store=function(e){var t=gs.compositions.list,i=t.findIndex(function(t){return e.id===t.id});e.id=e.id||common.uuid(),e.name=e.name||"Untitled",i>-1?(t[i]=e,ui.save.updateComposition(e)):(t.push(e),ui.save.addComposition(e)),localStorage.compositions=JSON.stringify(t)},gs.sample.create=function(e){var t=gs.wctx.createSample(e.wbuff);return e.wbuff.buffer||e.wbuff._setDuration(e.bufferDuration),t.data={selected:!1,gsfile:e},++e.nbSamples,ui.file.used(e),ui.sample.create(t),ui.sample.duration(t),t},gs.sample.delete=function(e){if(e){var t=e.data;t.oldSelected=!!t.selected,gs.sample.select(e,!1),--t.gsfile.nbSamples||ui.file.unused(t.gsfile),e.stop(),t.track.removeSample(e),gs.composition.remove(e),ui.sample.delete(e)}},gs.sample.duration=function(e,t){e.duration=Math.max(0,Math.min(t,e.bufferDuration)),ui.sample.duration(e)},gs.sample.inTrack=function(e,t){var i=e.data,n=waFwk.tracks[t].userData;e.disconnect(),e.connect(n.wfilters),i.track&&i.track.removeSample(e),i.track=n,n.samples.push(e),ui.sample.inTrack(e)},gs.sample.mute=function(e){lg("sample muted (in development)")},gs.sample.select=function(e,t){e&&e.data.selected!==t&&("boolean"!=typeof t&&(t=!e.data.selected),t?gs.selectedSamples.push(e):gs.selectedSamples.splice(gs.selectedSamples.indexOf(e),1),e.data.selected=t,ui.sample.select(e))},gs.sample.slip=function(e,t){e.offset=Math.min(e.bufferDuration,Math.max(t,0)),ui.sample.waveform(e)},gs.sample.when=function(e,t){e.when=t,ui.sample.when(e)},gs.samples.selected.do=function(e,t){e&&(e.data.selected?gs.selectedSamples.forEach(t):t(e))},gs.samples.selected.min=function(e,t){return e.data.selected?gs.selectedSamples.reduce(function(e,i){return Math.min(e,t(i))},1/0):t(e)},gs.samples.selected.max=function(e,t){return e.data.selected?gs.selectedSamples.reduce(function(e,i){return Math.max(e,t(i))},-1/0):t(e)},function(){gs.samples.selected.copy=function(){var i=1/0,n=-1/0;t=gs.selectedSamples.map(function(e){return i=Math.min(i,e.when),n=Math.max(n,e.when+e.duration),e}),ui.isMagnetized&&(i=ui.secFloor(i),n=ui.secCeil(n)),e=n-i},gs.samples.selected.paste=function(){t.length&&(gs.history.pushExec("paste",{selected:gs.selectedSamples.slice(),allDuration:e,copied:t,pasted:t.map(function(e){return gs.sample.create(e.data.gsfile)})}),gs.samples.selected.copy())};var e,t=[]}(),gs.samples.selected.cut=function(e,t){var i=e.data.selected?gs.selectedSamples.slice():[e];gs.history.pushExec("cut",{duration:t-e.when,samples:i,newSamples:i.map(function(e){return gs.sample.create(e.data.gsfile)})})},gs.samples.selected.delete=function(){gs.selectedSamples.length&&(gs.history.pushExec("delete",{samples:gs.selectedSamples.slice()}),gs.selectedSamples.length=0)},gs.samples.selected.duration=function(e,t){return t=t<0?-Math.min(-t,gs.samples.selected.min(e,function(e){return e.duration})):Math.min(t,gs.samples.selected.min(e,function(e){return e.bufferDuration-e.duration})),gs.samples.selected.do(e,function(e){gs.sample.duration(e,e.duration+t)}),t},gs.samples.selected.when=function(e,t){return t<0&&(t=-Math.min(-t,gs.samples.selected.min(e,function(e){return e.when}))),gs.samples.selected.do(e,function(e){gs.sample.when(e,Math.max(0,e.when+t))}),t},gs.samples.selected.slip=function(e,t){return t=t<0?-Math.min(-t,gs.samples.selected.min(e,function(e){return e.bufferDuration-e.offset})):Math.min(t,gs.samples.selected.min(e,function(e){return e.offset})),gs.samples.selected.do(e,function(e){gs.sample.slip(e,e.offset-t)}),t},gs.samples.selected.cropEnd=gs.samples.selected.duration,gs.samples.selected.cropStart=function(e,t){return(t=-gs.samples.selected.duration(e,-t))&&(gs.samples.selected.when(e,t),gs.samples.selected.slip(e,-t)),t},gs.samples.selected.unselect=function(){gs.selectedSamples.forEach(function(e){e.data.selected=!1,ui.sample.select(e)}),gs.selectedSamples.length=0},document.body.addEventListener("click",function(){ui.save.hideList()}),ui.dom.clockUnits.onclick=function(e){var t=e.target.className;return"s"!==t&&"b"!==t||ui.clock.setUnit(gs.clockUnit=t),!1},function(){var e,t=!1,i={panel:function(e){var t=e.pageX;ui.setFilesWidth(t<35?0:t)},trackNames:function(e){var t=e.pageX-ui.dom.grid.getBoundingClientRect().left;ui.setTrackNamesWidth(t<35?0:t)}};Array.from(document.querySelectorAll(".extend")).forEach(function(n){n.onmousedown=function(n){0===n.button&&(t=!0,ui.cursor("app","col-resize"),e=i[this.dataset.mousemoveFn])}}),document.body.addEventListener("mouseup",function(e){0===e.button&&t&&(t=!1,ui.cursor("app",null))}),document.body.addEventListener("mousemove",function(i){t&&e(i)})}(),function(){function e(){o.forEach(function(e){gs.files.some(function(t){var i=t.file?t.file.size:t.size;if(t.fullname===e.name&&i===e.size)return t.file||gs.file.joinFile(t,e),!0})||gs.file.create(e)})}function t(t){for(var o,a=0,r=[];o=t[a++];)o.webkitGetAsEntry&&(o=o.webkitGetAsEntry())?r.push(i(o)):(o=o.getAsFile())&&(lg("item.getAsFile()",o),n(o));Promise.all(r).then(function(){gs.compositions.readFile(s).then(function(){e()})})}function i(e){return new Promise(function(t){e.isFile?e.file(function(e){n(e),t()}):e.isDirectory?e.createReader().readEntries(function(e){var n=[];e.forEach(function(e){n.push(i(e))}),Promise.all(n).then(t)}):t()})}function n(e){switch(/[^.]*.?([^.]*)$/.exec(e.name)[1].toLowerCase()){case"gs":case"txt":case"json":s=e,gs.reset();break;case"mp3":case"mpg":case"mpeg":case"wav":case"wave":case"ogg":o.push(e)}}var s,o;document.body.ondragover=function(){return!1},document.body.ondrop=function(i){var a,r=0,l=i&&i.dataTransfer;if(o=[],s=!1,l.items&&l.items.length)t(l.items);else{for(;a=l.files[r++];)n(a);gs.compositions.readFile(s).then(function(){e()})}return!1}}(),function(){function e(e){return n.every(function(t){return t===e||!i.contains(t)})}function t(e){i.toggle("used",e),i.toggle("loaded",e),i.toggle("unloaded",e)}ui.dom.filesFilters.onclick=ui.dom.filesFilters.oncontextmenu=function(){return!1},ui.dom.filesFilters.onmouseup=function(n){var s,o=n.target;"A"===o.nodeName&&(0===n.button?i.toggle(o.className):2===n.button&&(t(s=i.contains(o.className)&&e(o.className)),s||i.add(o.className)))};var i=ui.dom.filesFilters.classList,n=["used","loaded","unloaded"];t(!0)}(),function(){function e(){n&&(ui.selectTool(n),n=null),t=!1}ui.px_x=ui.px_y=ui.px_xRel=ui.px_yRel=0,window.addEventListener("blur",e),ui.dom.gridCols.onwheel=function(e){if("zoom"===ui.currentTool)return ui.tool.zoom.wheel(e),!1},ui.dom.gridCols.onscroll=function(){ui.gridScrollTop=ui.dom.gridCols.scrollTop,ui.updateGridTopShadow()},ui.dom.tracksLines.oncontextmenu=function(){return!1},ui.dom.tracksLines.onmousedown=function(e){if(!t){t=!0,i=ui.getGridSec(e.pageX),ui.px_x=e.pageX,ui.px_y=e.pageY,2===e.button&&(n=ui.currentTool,ui.selectTool("delete"));var s=ui.tool[ui.currentTool].mousedown;s&&s(e)}},document.body.onwheel=function(e){if(e.ctrlKey)return!1},document.body.addEventListener("mousemove",function(e){if(t){var n=ui.tool[ui.currentTool].mousemove,s=ui.getGridSec(e.pageX);ui.px_xRel=e.pageX-ui.px_x,ui.px_yRel=e.pageY-ui.px_y,ui.px_x=e.pageX,ui.px_y=e.pageY,n&&(i+=n(e,s-i))}}),document.body.addEventListener("mouseup",function(i){if(t){var n=ui.tool[ui.currentTool].mouseup;n&&n(i),e()}});var t,i,n}(),function(){function e(e){i=ui.currentTool,ui.selectTool(e.name)}function t(t,n){"keydown"===n.type?e(t):i&&(ui.selectTool(i),i=null)}keyboardRouter({fn:t,when:"down,up",keys:["alt"],name:"hand"},{fn:t,when:"down,up",keys:["ctrl"],name:"zoom"},{fn:t,when:"down,up",keys:["shift"],name:"select"},{fn:gs.playStop,keys:[" "]},{fn:gs.playPause,keys:["ctrl"," "]},{fn:gs.samples.selected.delete,keys:["delete"]},{fn:gs.samples.selected.copy,keys:["ctrl","c"]},{fn:gs.samples.selected.paste,keys:["ctrl","v"]},{fn:gs.history.undo,keys:["ctrl","z"]},{fn:gs.history.redo,keys:["ctrl","shift","z"]},{fn:gs.compositions.saveCurrent,keys:["ctrl","s"]});var i}(),ui.dom.btnFiles.onclick=ui.panelSection.bind(null,"files"),ui.dom.btnHistory.onclick=ui.panelSection.bind(null,"history"),window.onresize=ui.resize(),ui.dom.toolBtns.tool={},ui.dom.toolBtns.forEach(function(e){ui.dom.toolBtns.tool[e.dataset.tool]=e,e.onclick=ui.selectTool.bind(null,e.dataset.tool)}),function(){ui.tool.cut={mousedown:function(t){e=t.target.gsSample},mouseup:function(t){e&&gs.samples.selected.cut(e,ui.getGridSec(t.pageX)),e=null}};var e}(),function(){function e(e){var i=e.target.gsSample;i&&(gs.sample.delete(i),t.push(i))}ui.tool.delete={mousedown:e,mousemove:e,mouseup:function(){t.length&&(gs.history.push("delete",{samples:t.slice()}),t.length=0)}};var t=[]}(),ui.tool.hand={start:function(){ui.cursor("grid","grab")},end:function(){ui.cursor("grid",null)},mousedown:function(){ui.cursor("app","grabbing")},mouseup:function(){ui.cursor("app",null)},mousemove:function(e){ui.setTrackLinesLeft(ui.trackLinesLeft+ui.px_xRel),ui.setGridScrollTop(ui.gridScrollTop-ui.px_yRel),ui.timeline.update(),ui.tracksBg.update()}},ui.tool.mute={},function(){ui.tool.paint={mousedown:function(l){var u=l.target.gsSample;!u&&gs.selectedSamples.length?(gs.history.push("select",{samples:gs.selectedSamples.slice()}),gs.samples.selected.unselect()):u&&(t=u.data.track.id,i=u.when,n=u.offset,s=u.duration,a=l.target.classList.contains("start"),(o=a||l.target.classList.contains("end"))?(r=a?"crop":"cropEnd",u.data[a?"elCropStart":"elCropEnd"].classList.add("hover")):r="move",e=u,ui.cursor("app",o?a?"w-resize":"e-resize":"grabbing"))},mouseup:function(){e&&(gs.samples.selected.do(e,function(e){gs.composition.update(e,"mv")}),o&&(e.data[a?"elCropStart":"elCropEnd"].classList.remove("hover"),o=a=!1),e.data.track.id===t&&e.when===i&&e.offset===n&&e.duration===s||gs.history.push(r,{sample:e,track:e.data.track.id-t,when:e.when-i,offset:e.offset-n,duration:e.duration-s}),e=t=i=n=s=null,ui.cursor("app",null))},mousemove:function(t,i){if(e){if(!o){var n=(t=t.target).uitrack||t.gsSample&&t.gsSample.data.track,s=n&&n.id-e.data.track.id;s&&(e.data.selected?(s<0&&(s=-Math.min(-s,gs.selectedSamples.reduce(function(e,t){return Math.min(e,t.data.track.id)},1/0))),gs.selectedSamples.forEach(function(e){gs.sample.inTrack(e,e.data.track.id+s)})):gs.sample.inTrack(e,n.id))}return o?a?gs.samples.selected.cropStart(e,i):gs.samples.selected.cropEnd(e,i):gs.samples.selected.when(e,i)}}};var e,t,i,n,s,o,a,r}(),function(){ui.tool.select={mousedown:function(i){var n=i.target.gsSample;a=[],i.shiftKey?n&&(a.push(n),gs.sample.select(n)):(gs.selectedSamples.forEach(function(e){e!==n&&a.push(e)}),gs.samples.selected.unselect(),gs.sample.select(n,!0)),e=i.pageX,t=i.pageY,s=!0},mouseup:function(e){a&&a.length&&(gs.history.push("select",{samples:a}),a=null),s=o=!1,l.style.width=l.style.height="0px",l.remove()},mousemove:function(u){if(s){var c=u.pageX,d=u.pageY;if(!o&&Math.max(Math.abs(c-e),Math.abs(d-t))>5&&(++r,o=!0,i=ui.getTrackFromPageY(t).id,n=ui.getGridSec(e),ui.dom.tracksLines.appendChild(l)),o){var p=ui.getTrackFromPageY(d),m=p?p.id:0,f=Math.min(i,m),h=Math.max(i,m),g=Math.max(0,ui.getGridSec(c)),v=Math.min(n,g),w=Math.max(n,g);gs.composition.samples.forEach(function(e){if(f<=e.data.track.id&&e.data.track.id<=h){var t=e.when,i=e.duration+t;if(v<=t&&t<w||v<i&&i<=w||t<=v&&w<=i)return void(e.data.selected||(e.data.squareSelected=r,gs.sample.select(e,!0),a.push(e)))}e.data.squareSelected===r&&(delete e.data.squareSelected,gs.sample.select(e,!1),a.splice(a.indexOf(e),1))}),l.style.left=v*ui.BPMem+"em",l.style.width=(w-v)*ui.BPMem+"em",l.style.top=f*ui.trackHeight+"px",l.style.height=(h-f+1)*ui.trackHeight+"px"}}}};var e,t,i,n,s,o,a,r=0,l=ui.createHTML("<div id='squareSelection'>")[0]}(),function(){ui.tool.slip={mousedown:function(i){(e=i.target.gsSample)&&(t=e.offset)},mouseup:function(){e&&(gs.history.push("slip",{sample:e,offset:t-e.offset}),gs.samples.selected.do(e,function(e){gs.composition.update(e,"mv")})),e=null},mousemove:function(t,i){if(e)return gs.samples.selected.slip(e,i)}};var e,t}(),function(){function e(e,t){ui.setGridZoom(ui.gridZoom*t,e.pageX-ui.filesWidth-ui.trackNamesWidth)}ui.tool.zoom={start:function(){ui.cursor("grid","zoom-in")},end:function(){ui.cursor("grid",null)},keydown:function(e){18===e.keyCode&&ui.cursor("grid","zoom-out")},keyup:function(e){18===e.keyCode&&ui.cursor("grid","zoom-in")},wheel:function(t){e(t,t.deltaY<0?1.1:.9)},mousedown:function(t){0===t.button&&e(t,t.altKey?.7:1.3)}}}(),function(){gs.wctx=new gswaContext,gs.ctx=gs.wctx.ctx,gs.analyserNode=gs.wctx.ctx.createAnalyser(),gs.analyserNode.fftSize=256,gs.analyserData=new Uint8Array(gs.analyserNode.frequencyBinCount),gs.composition=gs.wctx.createComposition(),gs.wctx.filters.pushBack(gs.analyserNode),ui.resize(),ui.setFilesWidth(200),ui.setTrackLinesLeft(0),ui.setTrackNamesWidth(125),ui.setGridZoom(1.5,0),ui.visual.on(),ui.btnMagnet.toggle(!0),ui.tracksBg.update(),ui.timelineLoop.toggle(!1),gs.history.reset(),gs.bpm(120),gs.currentTime(0),gs.compositions.init(),gs.composition.onended(gs.compositionStop),ui.dom.btnFiles.click(),ui.dom.clockUnits.querySelector(".s").click(),ui.dom.menu.querySelector("[data-tool='paint']").click(),checkLogin()}(),function(){for(var e=0;e<42;++e)waFwk.do.addTrack({});ui.trackHeight=waFwk.tracks[0].userData.elColNamesTrack.offsetHeight}(),"gridsound.github.io"===location.host&&(!function(e,t,i,n,s,o,a){e.GoogleAnalyticsObject=s,e[s]=e[s]||function(){(e[s].q=e[s].q||[]).push(arguments)},e[s].l=1*new Date,o=t.createElement(i),a=t.getElementsByTagName(i)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",a.parentNode.insertBefore(o,a)}(window,document,"script",0,"ga"),ga("create","UA-418864-6","auto"),ga("send","pageview"));