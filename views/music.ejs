<!DOCTYPE html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Angular Material style sheet -->
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">
    <link rel="stylesheet" href="/stylesheets/style.css">

</head>

<body ng-app="musicCollab" ng-cloak>
    <div ng-controller="AppCtrl as appCtrl" ng-cloak>

        <!-- Play Forward Rewind -->
        <md-grid-list md-cols-xs="3" md-cols-sm="3" md-cols-md="3" md-cols-gt-md="3" md-row-height-gt-md="2:1" md-row-height="1:1" md-gutter="12px" md-gutter-gt-sm="1px">

            <md-grid-tile class="white">
                <ng-md-icon icon="fast_rewind" style="fill: pink" size="100"></ng-md-icon>
            </md-grid-tile>

            <md-grid-tile class="white">
                <ng-md-icon icon="play_circle_outline" style="fill: pink" size="100" ng-click="playAudio()"></ng-md-icon>
            </md-grid-tile>

            <md-grid-tile class="white">
                <ng-md-icon icon="fast_forward" style="fill: pink" size="100"></ng-md-icon>
            </md-grid-tile>

        </md-grid-list>


        <!-- Block Layers -->
        <md-grid-list ng-repeat="layer in layers track by $index" md-cols-xs="5" md-cols-sm="5" md-cols-md="5" md-cols-gt-md="5" md-row-height-gt-md="1.5:1" md-row-height="2:2" md-gutter="12px" md-gutter-gt-sm="1px">
            <md-grid-tile ng-repeat="block in layer.blocks track by $index" ng-class="block">
            </md-grid-tile>
        </md-grid-list>

        <md-grid-list ng-if="justAdded==true" md-cols-xs="5" md-cols-sm="5" md-cols-md="5" md-cols-gt-md="5" md-row-height-gt-md="1.5:1" md-row-height="2:2" md-gutter="12px" md-gutter-gt-sm="1px">
            <md-grid-tile ng-repeat="block in currentLayer.blocks track by $index" ng-class="block" ng-click="showTabDialog($event, $index)">
            </md-grid-tile>
        </md-grid-list>

        <!-- Add/Submit Button -->
        <ng-md-icon icon="add_circle_outline" style="fill: pink" size="100" layout="row" layout-align="center" ng-if="justAdded==false" ng-click="addLayer()"></ng-md-icon>
        <ng-md-icon icon="file_upload" style="fill: pink" size="100" layout="row" layout-align="center" ng-if="justAdded==true" ng-click="submitLayer()"></ng-md-icon>

    </div>
    <!-- Angular Material requires Angular.js Libraries -->
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/SVG-Morpheus/0.3.2/svg-morpheus.js"></script>


    <!-- Angular Material Library -->
    <script src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular-material-icons/0.7.1/angular-material-icons.min.js"></script>

    <!-- Your application bootstrap  -->
    <script type="text/javascript">
        angular.module('musicCollab', ['ngMaterial', 'ngMdIcons'])
            .controller('AppCtrl', function($scope, $mdDialog) {
                $scope.noBlocksInLayer = 5;
                $scope.justAdded = false;
                $scope.layers = [];
                $scope.musicalLayers = [];
                $scope.currentLayer = [];
                $scope.currentMusicalLayer = [];
                $scope.notes = [];

                $scope.innit = function() {
                    <!-- Add Sounds to Array -->
                    var sound1 = new Audio('audio/sound1.wav');
                    var sound2 = new Audio('audio/sound2.wav');
                    var sound3 = new Audio('audio/sound3.wav');
                    var sound4 = new Audio('audio/sound4.wav');
                    var sound5 = new Audio('audio/sound5.wav');
                    var sound6 = new Audio('audio/sound6.wav');
                    var sound7 = new Audio('audio/sound7.wav');
                    $scope.notes.push(sound1);
                    $scope.notes.push(sound2);
                    $scope.notes.push(sound3);
                    $scope.notes.push(sound4);
                    $scope.notes.push(sound5);
                    $scope.notes.push(sound6);
                    $scope.notes.push(sound7);

                }

                $scope.innit();

                $scope.addLayer = function() {
                    var blocks = new Array($scope.noBlocksInLayer);
                    for (var i = 0; i < blocks.length; i++) {
                        blocks[i] = "red";
                    }
                    $scope.currentLayer = {
                        blocks: blocks
                    };

                    var notes = new Array($scope.noBlocksInLayer);
                    $scope.currentMusicalLayer = {
                        notes: notes
                    };

                    $scope.justAdded = true;
                };

                $scope.submitLayer = function() {
                    $scope.layers.push($scope.currentLayer);
                    $scope.currentLayer = [];
                    $scope.justAdded = false;
                };

                $scope.playAudio = function() {
                    $scope.currentMusicalLayer.notes[0].play();
                    for (var i = 0; i < $scope.currentMusicalLayer.notes.length - 1; i++) {
                        addEndListener(i);
                    }
                };

                function addEndListener(index) {
                    $scope.currentMusicalLayer.notes[index].addEventListener('ended', function() {
                        $scope.currentMusicalLayer.notes[index + 1].play();
                    });

                }

                $scope.showTabDialog = function(ev, index) {
                    $mdDialog.show({
                            controller: DialogController,
                            templateUrl: '/html/editBlock.html',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose: false
                        })
                        .then(function(response) {
                            if (response.color != "none") {
                                $scope.currentLayer.blocks[index] = response.color;
                            }
                            if (response.sound != "none") {
                                $scope.currentMusicalLayer.notes[index] = $scope.notes[response.sound];
                            }
                        });
                };

                function DialogController($scope, $mdDialog) {
                    $scope.color = "none";
                    $scope.sound = "none";

                    $scope.select = function(color, sound) {
                        $scope.color = color;
                        $scope.sound = sound;
                    };
                    $scope.hide = function() {
                        $mdDialog.hide();
                    };

                    $scope.cancel = function() {
                        $mdDialog.cancel();
                    };

                    $scope.answer = function() {
                        $mdDialog.hide({
                            color: $scope.color,
                            sound: $scope.sound
                        });
                    };
                };
            });

    </script>

</body>

</html>
